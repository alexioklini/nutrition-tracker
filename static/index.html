<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ¥— Nutrition Tracker</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{background:#0d1117;color:#c9d1d9}
.card{background:#161b22;border:1px solid #30363d}
.progress{background:#21262d;height:28px;border-radius:8px}
.meal-card{border-left:4px solid #58a6ff;margin-bottom:8px;padding:10px 14px;background:#161b22;border-radius:6px}
.meal-card.breakfast{border-color:#f0883e}.meal-card.lunch{border-color:#3fb950}.meal-card.dinner{border-color:#bc8cff}.meal-card.snack{border-color:#58a6ff}
.btn-del{opacity:0.5}.btn-del:hover{opacity:1}
canvas{max-height:220px}
.macro-label{font-size:0.85rem;opacity:0.7}
</style>
</head>
<body>
<div class="container py-4" style="max-width:900px">
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">ğŸ¥— Nutrition Tracker</h3>
  <div><input type="date" id="dateInput" class="form-control form-control-sm" style="width:160px;display:inline-block">
  <button class="btn btn-sm btn-primary ms-2" onclick="showAddModal()">+ Mahlzeit</button></div>
</div>

<!-- Recommendations -->
<div id="recsCard" class="card p-3 mb-3" style="border-color:#238636;display:none">
  <div class="d-flex justify-content-between align-items-center mb-2" style="cursor:pointer" onclick="toggleAcc('recsBody')">
    <h6 class="mb-0">ğŸ’¡ Empfehlungen fÃ¼r den Rest des Tages <span id="recsBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></h6>
    <span id="recsSummary" class="text-muted" style="font-size:0.85rem"></span>
  </div>
  <div id="recsBody">
    <div id="recsContent"></div>
  </div>
</div>

<!-- Summary -->
<div class="card p-3 mb-3">
  <div class="d-flex justify-content-between mb-1"><strong>Kalorien</strong><span id="calText">0 / 2025 kcal</span></div>
  <div class="progress"><div id="calBar" class="progress-bar bg-success" style="width:0%"></div></div>
  <div class="d-flex justify-content-between mb-1 mt-2">
    <small>â˜• Koffein/Teein</small>
    <span id="caffeineText" style="font-size:0.85rem">0 / 400 mg</span>
  </div>
  <div class="progress" style="height:8px">
    <div id="caffeineBar" class="progress-bar" style="width:0%;background:#8b6914"></div>
  </div>
  <div id="workoutBar" class="mt-2" style="display:none"></div>
  <div class="row mt-3 text-center">
    <div class="col-4"><canvas id="donutChart" height="180"></canvas></div>
    <div class="col-8 d-flex align-items-center">
      <div class="row w-100" id="macroStats"></div>
    </div>
  </div>
</div>

<!-- Meals -->
<div id="mealsList" class="mb-4"></div>

<!-- Supplements -->
<div class="card p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center" style="cursor:pointer" onclick="toggleAcc('suppBody')">
    <h6 class="mb-0">ğŸ’Š Supplements <span id="suppBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></h6>
    <span id="suppProgress" class="text-muted" style="font-size:0.85rem">0 / 12 Dosen heute eingenommen</span>
  </div>
  <div id="suppBody" style="display:none">
    <div class="progress mt-2 mb-3" style="height:12px">
      <div id="suppBar" class="progress-bar bg-info" style="width:0%"></div>
    </div>
    <div id="suppList"></div>
  </div>
</div>

<!-- Prostata-Analyse -->
<div class="card p-3 mb-3">
  <h6 style="cursor:pointer" onclick="toggleAcc('prostataBody')" class="d-flex align-items-center gap-2 flex-wrap">
    <span>ğŸ”¬ Prostata-Analyse <span id="prostataBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></span>
    <span id="prostataAlerts" class="d-flex gap-1 flex-wrap"></span>
  </h6>
  <div id="prostataBody" style="display:none">
    <div class="table-responsive">
      <table class="table table-sm table-dark mb-2" style="font-size:0.85rem">
        <thead><tr><th>Substanz</th><th>Quelle</th><th>TÃ¤gl. Menge</th><th>Opt. Bereich</th><th>Status</th></tr></thead>
        <tbody id="prostataTableBody">
          <tr><td colspan="5" class="text-muted text-center">Laden...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="alert alert-info py-2 mb-2" style="font-size:0.85rem">
      ğŸ’¡ <strong>Lycopin-Tipp:</strong> 1â€“2 EL Tomatenmark tÃ¤glich in SoÃŸen liefert 10â€“30mg Lycopin mit hÃ¶chster BioverfÃ¼gbarkeit â€” wÃ¼rde den einzigen Mangel im Stack beheben.
    </div>
    <div class="alert alert-warning py-2 mb-2" style="font-size:0.85rem">
      âš ï¸ <strong>GrÃ¼ner Tee-PS:</strong> NIEMALS nÃ¼chtern (HepatotoxizitÃ¤t!) â€” immer zu einer Mahlzeit. Ab 19.02.2026: 2 Kaps. morgens + 1 Kaps. abends.
    </div>
    <div class="alert alert-secondary py-2 mb-0" style="font-size:0.85rem">
      âœ… <strong>Vitamin D3:</strong> Dekristolvit D3 4.000 IU (morgens zum FrÃ¼hstÃ¼ck) + 800 IU aus curcumin-Loges = <strong>4.800 IU/Tag</strong>. Knapp Ã¼ber konservativem EU-Limit, bei aktiver Surveillance vertretbar und von Onkologen empfohlen.
    </div>
  </div>
</div>

<!-- Herz-Kreislauf Analyse -->
<div class="card p-3 mb-3">
  <h6 style="cursor:pointer" onclick="toggleAcc('cardioBody')" class="d-flex align-items-center gap-2 flex-wrap">
    <span>â¤ï¸ Herz-Kreislauf Analyse <span id="cardioBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></span>
    <span id="cardioAlerts" class="d-flex gap-1 flex-wrap"></span>
  </h6>
  <div id="cardioBody" style="display:none">
    <div class="table-responsive">
      <table class="table table-sm table-dark mb-2" style="font-size:0.85rem">
        <thead><tr><th>Substanz</th><th>Quelle</th><th>TÃ¤gl. Menge</th><th>Opt. Bereich</th><th>Status</th><th>Hinweis</th></tr></thead>
        <tbody id="cardioTableBody">
          <tr><td colspan="6" class="text-muted text-center">Laden...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="alert alert-info py-2 mb-2" style="font-size:0.85rem">
      ğŸ’Š <strong>MiraCHOL-Synergie:</strong> Monacolin K (Cholesterin-Hemmer) + Ubiquinol (CoQ10-Schutz) â€” clevere Kombination: Monacolin K erschÃ¶pft kÃ¶rpereigenes CoQ10, Ubiquinol kompensiert das direkt.
    </div>
    <div class="alert alert-info py-2 mb-2" style="font-size:0.85rem">
      ğŸ£ <strong>Lachs-Tipp:</strong> 2â€“3Ã— pro Woche 150g Lachs senkt Triglyzeride deutlich (EPA/DHA Omega-3).
    </div>
    <div class="alert alert-warning py-2 mb-0" style="font-size:0.85rem">
      ğŸ¬ <strong>Zucker-Hinweis:</strong> ErhÃ¶hter Zuckerkonsum â†’ Triglyzeride â†‘ â†’ LDL â†‘ â€” Monacolin K und Omega-3 wirken dem entgegen.
    </div>
  </div>
</div>

<!-- Hydration -->
<div class="card p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0">ğŸ’§ FlÃ¼ssigkeit</h6>
    <div class="d-flex gap-1">
      <button class="btn btn-sm btn-outline-info" onclick="addQuickWater(250)" title="Glas Wasser">+250ml</button>
      <button class="btn btn-sm btn-outline-info" onclick="addQuickWater(500)" title="Flasche">+500ml</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="showHydrationModal()">+Andere</button>
    </div>
  </div>
  <div id="hydrationDisplay"></div>
</div>

<!-- Hydration Modal -->
<div class="modal fade" id="hydrationModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content" style="background:#161b22">
<div class="modal-header border-secondary"><h5 class="modal-title">ğŸ’§ GetrÃ¤nk hinzufÃ¼gen</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
  <select id="hType" class="form-select form-select-sm mb-2">
    <option value="water">Wasser</option>
    <option value="tea">Tee</option>
    <option value="coffee">Kaffee</option>
    <option value="juice">Saft</option>
    <option value="other">Andere</option>
  </select>
  <input id="hAmount" type="number" class="form-control form-control-sm mb-2" placeholder="Menge (ml)" value="250">
  <input id="hDesc" class="form-control form-control-sm mb-2" placeholder="Beschreibung (optional)">
  <button class="btn btn-info btn-sm w-100" onclick="addHydration()">HinzufÃ¼gen</button>
</div>
</div></div></div>

<!-- NÃ¤hrwert-Analyse -->
<div class="card p-3 mb-3">
  <h6 style="cursor:pointer" onclick="toggleAcc('nutriBody')">ğŸ”¬ NÃ¤hrwert-Analyse <span id="nutriBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></h6>
  <div id="macroDistDisplay"></div>
  <div id="nutriBody" style="display:none">
    <div id="nutriAnalysis"></div>
  </div>
</div>

<!-- MikronÃ¤hrstoffe -->
<div class="card p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center" style="cursor:pointer" onclick="toggleAcc('microBody')">
    <h6 class="mb-0">ğŸ§¬ MikronÃ¤hrstoffe <span id="microBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></h6>
    <span id="microSummary" class="text-muted" style="font-size:0.85rem"></span>
  </div>
  <div id="microBody" style="display:none">
    <div id="microBars" class="mt-2"></div>
  </div>
</div>

<!-- Week Trend -->
<div class="card p-3 mb-3"><h6>ğŸ“Š Wochentrend</h6><canvas id="weekChart" height="140"></canvas></div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="mealModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content" style="background:#161b22">
<div class="modal-header border-secondary"><h5 class="modal-title" id="modalTitle">Mahlzeit hinzufÃ¼gen</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<form id="mealForm">
<input type="hidden" id="mealId">
<div class="row g-2 mb-2">
  <div class="col-6"><select id="mType" class="form-select form-select-sm"><option value="breakfast">FrÃ¼hstÃ¼ck</option><option value="lunch">Mittagessen</option><option value="dinner">Abendessen</option><option value="snack">Snack</option></select></div>
  <div class="col-6"><input type="date" id="mDate" class="form-control form-control-sm"></div>
</div>
<input id="mDesc" class="form-control form-control-sm mb-2" placeholder="Beschreibung" required>
<div class="row g-2 mb-2">
  <div class="col-4"><input id="mCal" type="number" step="any" class="form-control form-control-sm" placeholder="kcal"></div>
  <div class="col-4"><input id="mProt" type="number" step="any" class="form-control form-control-sm" placeholder="Protein (g)"></div>
  <div class="col-4"><input id="mFat" type="number" step="any" class="form-control form-control-sm" placeholder="Fett (g)"></div>
</div>
<div class="row g-2 mb-2">
  <div class="col-4"><input id="mCarbs" type="number" step="any" class="form-control form-control-sm" placeholder="KH (g)"></div>
  <div class="col-4"><input id="mFiber" type="number" step="any" class="form-control form-control-sm" placeholder="Ballast. (g)"></div>
  <div class="col-4"><input id="mSugar" type="number" step="any" class="form-control form-control-sm" placeholder="Zucker ges. (g)"></div>
</div>
<div class="row g-2 mb-2">
  <div class="col-6"><input id="mSugarNat" type="number" step="any" class="form-control form-control-sm" placeholder="Zucker natÃ¼rlich (g)"></div>
  <div class="col-6"><input id="mSugarAdd" type="number" step="any" class="form-control form-control-sm" placeholder="Zucker zugesetzt (g)"></div>
</div>
<details class="mb-2"><summary class="text-muted" style="font-size:0.8rem;cursor:pointer">ğŸ§¬ MikronÃ¤hrstoffe (optional)</summary>
<div class="row g-2 mt-1">
  <div class="col-4"><input id="mVitC" type="number" step="any" class="form-control form-control-sm" placeholder="Vit C (mg)"></div>
  <div class="col-4"><input id="mVitD" type="number" step="any" class="form-control form-control-sm" placeholder="Vit D (IU)"></div>
  <div class="col-4"><input id="mVitK" type="number" step="any" class="form-control form-control-sm" placeholder="Vit K (mcg)"></div>
</div>
<div class="row g-2 mt-1">
  <div class="col-3"><input id="mPotassium" type="number" step="any" class="form-control form-control-sm" placeholder="Kalium (mg)"></div>
  <div class="col-3"><input id="mMagnesium" type="number" step="any" class="form-control form-control-sm" placeholder="Mg (mg)"></div>
  <div class="col-3"><input id="mZinc" type="number" step="any" class="form-control form-control-sm" placeholder="Zink (mg)"></div>
  <div class="col-3"><input id="mSelenium" type="number" step="any" class="form-control form-control-sm" placeholder="Selen (mcg)"></div>
</div>
<div class="row g-2 mt-1">
  <div class="col-4"><input id="mIron" type="number" step="any" class="form-control form-control-sm" placeholder="Eisen (mg)"></div>
  <div class="col-4"><input id="mCalcium" type="number" step="any" class="form-control form-control-sm" placeholder="Calcium (mg)"></div>
  <div class="col-4"><input id="mFolate" type="number" step="any" class="form-control form-control-sm" placeholder="FolsÃ¤ure (mcg)"></div>
</div>
</details>
<input id="mNotes" class="form-control form-control-sm mb-2" placeholder="Notizen">
<div id="componentsSection">
  <hr class="border-secondary my-2">
  <small class="text-muted">Zutaten / Komponenten</small>
  <div id="compList"></div>
  <a href="#" class="text-decoration-none" style="font-size:0.85rem" onclick="addCompRow();return false">+ Zutat hinzufÃ¼gen</a>
</div>
</form>
</div>
<div class="modal-footer border-secondary"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Abbrechen</button><button class="btn btn-primary btn-sm" onclick="saveMeal()">Speichern</button></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = '';
let currentDate = new Date().toISOString().slice(0,10);
const dateInput = document.getElementById('dateInput');
dateInput.value = currentDate;
dateInput.onchange = () => { currentDate = dateInput.value; loadAll(); loadSupplements(); loadProstataAnalysis(); loadCardioAnalysis(); loadCaffeine(); };

const mealLabels = {breakfast:'ğŸŒ… FrÃ¼hstÃ¼ck',lunch:'ğŸ½ï¸ Mittagessen',dinner:'ğŸŒ™ Abendessen',snack:'ğŸ Snacks'};
const mealColors = {breakfast:'#f0883e',lunch:'#3fb950',dinner:'#bc8cff',snack:'#58a6ff'};

async function loadAll() {
  const [meals, summary, week] = await Promise.all([
    fetch(`${API}/api/meals?date=${currentDate}`).then(r=>r.json()),
    fetch(`${API}/api/summary/${currentDate}`).then(r=>r.json()),
    fetch(`${API}/api/summary/week/${currentDate}`).then(r=>r.json())
  ]);
  window._allMeals = meals;
  // Also fetch prostate + cardio analysis for recommendations
  const [prostate, cardio] = await Promise.all([
    fetch(`${API}/api/prostate-analysis/${currentDate}`).then(r=>r.json()).catch(()=>({})),
    fetch(`${API}/api/cardio-analysis/${currentDate}`).then(r=>r.json()).catch(()=>({})),
  ]);
  window._prostateData = prostate;
  window._cardioData = cardio;
  renderSummary(summary);
  renderMeals(meals);
  renderNutriAnalysis(summary);
  renderHydration(summary.hydration);
  renderMicronutrients(summary);
  renderRecommendations(summary);
  renderWeek(week);
}

function renderSummary(s) {
  const t = s.totals, pct = Math.min(s.progress.calories, 100);
  const w = s.workout || {};
  const calGoal = s.goals.calories || 2000;
  const netCal = s.net_calories ?? Math.round(t.calories);

  // Kalorien-Header
  let calLabel = `${Math.round(t.calories)} / ${calGoal} kcal`;
  if (w.kcal_burned > 0) calLabel += ` (Netto: ${netCal} kcal)`;
  document.getElementById('calText').textContent = calLabel;

  const bar = document.getElementById('calBar');
  bar.style.width = pct+'%';
  bar.className = 'progress-bar ' + (pct > 100 ? 'bg-danger' : pct > 80 ? 'bg-warning' : 'bg-success');

  // Workout-Info
  const wDiv = document.getElementById('workoutBar');
  if (w.has_workout && w.kcal_burned > 0) {
    const zoneColors = {1:'#58a6ff',2:'#3fb950',3:'#ffc107',4:'#f0883e',5:'#f85149'};
    const zc = zoneColors[w.zone] || '#58a6ff';
    wDiv.style.display = '';
    wDiv.innerHTML = `<div class="p-2 rounded d-flex flex-wrap gap-3 align-items-center" style="background:#0d1117;font-size:0.85rem">
      <span>ğŸ‹ï¸ <strong>${w.duration_min} min</strong></span>
      ${w.avg_hr ? `<span>â¤ï¸ Ã˜ ${w.avg_hr} bpm <small class="text-muted">(HRmax ${w.hr_max})</small></span>` : ''}
      <span style="color:${zc}">âš¡ Zone ${w.zone}: ${w.zone_label}</span>
      <span>ğŸ”¥ âˆ’${w.kcal_burned} kcal verbrannt</span>
      <span style="color:#f0883e">ğŸ«™ ~${w.fat_g_burned}g Fett</span>
      <span style="color:#3fb950">ğŸŒ¾ ~${w.kh_g_burned}g KH</span>
      <span class="ms-auto text-muted">Kalorienkorrektur: +${w.kcal_burned} kcal Ziel</span>
    </div>`;
  } else {
    wDiv.style.display = 'none';
  }

  document.getElementById('macroStats').innerHTML = [
    ['Protein', t.protein_g, s.goals.protein_g, '#58a6ff'],
    ['Fett', t.fat_g, s.goals.fat_g, '#f0883e'],
    ['Kohlenhydrate', t.carbs_g, s.goals.carbs_g, '#3fb950'],
    ['Ballaststoffe', t.fiber_g, s.goals.fiber_g, '#bc8cff']
  ].map(([n,v,g,c])=>`<div class="col-6 mb-2"><div class="macro-label">${n}</div><strong style="color:${c}">${Math.round(v*10)/10}g</strong> <small class="text-muted">/ ${g}g</small></div>`).join('');

  const ww = s.workout || {};
  drawDonut(t.protein_g, Math.max(0, t.fat_g-(ww.fat_g_burned||0)), Math.max(0, t.carbs_g-(ww.kh_g_burned||0)));
}

function drawDonut(p, f, c) {
  const canvas = document.getElementById('donutChart'), ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2, H = canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2,2); const w=W/2, h=H/2, cx=w/2, cy=h/2, r=Math.min(w,h)/2-10, inner=r*0.6;
  ctx.clearRect(0,0,w,h);
  const total = p+f+c || 1;
  const slices = [[p,'#58a6ff','P'],[f,'#f0883e','F'],[c,'#3fb950','KH']];
  let angle = -Math.PI/2;
  slices.forEach(([v, color, label]) => {
    const sweep = (v/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,angle,angle+sweep); ctx.fillStyle=color; ctx.fill();
    angle += sweep;
  });
  ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fillStyle='#161b22'; ctx.fill();
  ctx.fillStyle='#c9d1d9'; ctx.font='bold 11px sans-serif'; ctx.textAlign='center';
  ctx.fillText(`${Math.round(p+f+c)}g`, cx, cy+4);
}

function renderMeals(meals) {
  const grouped = {};
  meals.forEach(m => { (grouped[m.meal_type] = grouped[m.meal_type]||[]).push(m); });
  let html = '';
  for (const type of ['breakfast','lunch','dinner','snack']) {
    const items = grouped[type];
    if (!items) continue;

    // Summen berechnen
    const sumCal  = items.reduce((a,m)=>a+m.calories,0);
    const sumProt = items.reduce((a,m)=>a+m.protein_g,0);
    const sumFat  = items.reduce((a,m)=>a+m.fat_g,0);
    const sumCarb = items.reduce((a,m)=>a+m.carbs_g,0);
    const accId = `acc-${type}`;

    // Accordion Header (Zusammenfassung)
    html += `
    <div class="meal-card ${type} mb-2 p-0" style="overflow:hidden">
      <div class="d-flex justify-content-between align-items-center px-3 py-2" 
           style="cursor:pointer" onclick="toggleAcc('${accId}')">
        <div>
          <strong>${mealLabels[type]}</strong>
          <span class="ms-2 text-muted" style="font-size:0.85rem">${items.length} Eintr.</span>
        </div>
        <div class="d-flex align-items-center gap-3">
          <span style="font-size:0.85rem">
            <strong>${Math.round(sumCal)} kcal</strong>
            <span class="text-muted ms-2">${Math.round(sumProt*10)/10}P Â· ${Math.round(sumFat*10)/10}F Â· ${Math.round(sumCarb*10)/10}KH</span>
          </span>
          <span id="${accId}-icon" style="transition:transform 0.2s">â–¼</span>
        </div>
      </div>
      <!-- Einzelpositionen (kollabierbar) -->
      <div id="${accId}" style="display:none;border-top:1px solid rgba(255,255,255,0.08)">`;

    items.forEach(m => {
      const hasComps = m.components && m.components.length > 0;
      const compId = `comp-${m.id}`;
      html += `
        <div class="d-flex justify-content-between align-items-start px-3 py-2" style="border-bottom:1px solid rgba(255,255,255,0.04)">
          <div style="flex:1">
            <span>${hasComps ? `<span style="cursor:pointer;font-size:0.8rem;margin-right:4px" onclick="toggleAcc('${compId}')" id="${compId}-icon">â–¶</span>` : ''}${m.description}</span>
            <br><small class="text-muted">${Math.round(m.calories)} kcal Â· ${m.protein_g}P Â· ${m.fat_g}F Â· ${m.carbs_g}KH${m.fiber_g>0?' Â· '+m.fiber_g+'Bal':''}</small>
            ${m.notes ? '<br><small class="text-muted fst-italic">'+m.notes+'</small>' : ''}
            ${hasComps ? `<div id="${compId}" style="display:none;margin-top:6px;padding-left:18px;border-left:2px solid rgba(255,255,255,0.1)">
              ${m.components.map(c => `<div style="font-size:0.82rem;padding:2px 0"><span style="color:#8b949e">â†³</span> ${c.description} <small class="text-muted">${Math.round(c.calories)} kcal Â· ${c.protein_g}P Â· ${c.fat_g}F Â· ${c.carbs_g}KH</small></div>`).join('')}
            </div>` : ''}
          </div>
          <div class="text-nowrap ms-2">
            <button class="btn btn-sm btn-outline-secondary me-1 py-0" onclick="editMeal(${m.id})">âœï¸</button>
            <button class="btn btn-sm btn-outline-danger btn-del py-0" onclick="deleteMeal(${m.id})">ğŸ—‘ï¸</button>
          </div>
        </div>`;
    });

    html += `
        <div class="px-3 py-2">
          <button class="btn btn-sm btn-outline-secondary py-0" onclick="addForType('${type}')">+ Eintrag hinzufÃ¼gen</button>
        </div>
      </div>
    </div>`;
  }
  document.getElementById('mealsList').innerHTML = html || '<p class="text-muted">Keine Mahlzeiten fÃ¼r diesen Tag.</p>';
}

function toggleAcc(id) {
  const el = document.getElementById(id);
  const icon = document.getElementById(id+'-icon');
  const open = el.style.display !== 'none';
  el.style.display = open ? 'none' : 'block';
  icon.style.transform = open ? '' : 'rotate(180deg)';
}

function addForType(type) {
  document.getElementById('mealId').value = '';
  document.getElementById('mealForm').reset();
  document.getElementById('mDate').value = currentDate;
  document.getElementById('mType').value = type;
  document.getElementById('compList').innerHTML = '';
  document.getElementById('modalTitle').textContent = 'Eintrag hinzufÃ¼gen';
  new bootstrap.Modal(document.getElementById('mealModal')).show();
}

function renderNutriAnalysis(s) {
  const t = s.totals, g = s.goals;
  const w = s.workout || {};
  const kcal = t.calories;

  // Netto-Werte nach Workout
  const netFat = Math.max(0, t.fat_g - (w.fat_g_burned || 0));
  const netKH  = Math.max(0, t.carbs_g - (w.kh_g_burned || 0));

  // Empfohlene Makro-Verteilung (% der Kalorien, auf Netto-Basis)
  const protKcal = t.protein_g * 4;
  const fatKcal  = netFat * 9;
  const carbKcal = netKH * 4;
  const totalMacroKcal = protKcal + fatKcal + carbKcal || 1;

  const protPct = Math.round(protKcal / totalMacroKcal * 100);
  const fatPct  = Math.round(fatKcal  / totalMacroKcal * 100);
  const carbPct = Math.round(carbKcal / totalMacroKcal * 100);

  const netCal = s.net_calories ?? Math.round(kcal);
  const calMin = Math.round((g.calories || 2000) * 0.8);
  const calMax = Math.round((g.calories || 2000) * 1.1);

  // Workout-Hinweis fÃ¼r Analyse
  const workoutNote = w.has_workout && w.kcal_burned > 0
    ? ` <small class="text-muted">Â· Netto nach Training: ${netCal} kcal</small>` : '';
  const fatNote = w.has_workout && w.fat_g_burned > 0
    ? `${fatPct}% Netto-Energie Â· ${w.fat_g_burned}g durch Training verbrannt` : `${fatPct}% der Energie`;
  const khNote = w.has_workout && w.kh_g_burned > 0
    ? `${carbPct}% Netto-Energie Â· ${w.kh_g_burned}g durch Training verbrannt` : `${carbPct}% der Energie`;

  // Zielkorridore
  const targets = [
    { name: 'Kalorien', unit: 'kcal', val: netCal, min: calMin, max: calMax, goal: g.calories || 2000, icon: 'ğŸ”¥', note: workoutNote ? `Brutto: ${Math.round(kcal)} kcal${workoutNote}` : '' },
    { name: 'Protein', unit: 'g', val: t.protein_g, min: 60, max: 120, goal: g.protein_g, icon: 'ğŸ’ª', note: `${protPct}% der Energie` },
    { name: 'Fett', unit: 'g', val: netFat, min: 45, max: 80, goal: g.fat_g, icon: 'ğŸ«™', note: fatNote },
    { name: 'Kohlenhydrate', unit: 'g', val: netKH, min: 180, max: 310, goal: g.carbs_g, icon: 'ğŸŒ¾', note: khNote },
    { name: 'Ballaststoffe', unit: 'g', val: t.fiber_g, min: 25, max: 40, goal: g.fiber_g, icon: 'ğŸ¥¦' },
    { name: 'Zucker', unit: 'g', val: t.sugar_g, min: 0, max: 50, goal: 50, icon: 'ğŸ¬', note: 'Max. 50g/Tag empfohlen', invert: true },
  ];

  // Empfohlene Makro-Verteilung Anzeige
  const macroDistHTML = `
    <div class="mb-3 p-2 rounded" style="background:#0d1117">
      <div class="d-flex justify-content-between mb-1"><small class="text-muted">Makro-Verteilung (% der Energie)</small><small class="text-muted">Empfehlung: P 15-25% Â· F 25-35% Â· KH 45-60%</small></div>
      <div class="d-flex rounded overflow-hidden" style="height:22px">
        <div style="width:${protPct}%;background:#58a6ff" title="Protein ${protPct}%"></div>
        <div style="width:${fatPct}%;background:#f0883e" title="Fett ${fatPct}%"></div>
        <div style="width:${carbPct}%;background:#3fb950" title="KH ${carbPct}%"></div>
      </div>
      <div class="d-flex gap-3 mt-1">
        <small><span style="color:#58a6ff">â– </span> Protein ${protPct}% ${protPct>=15&&protPct<=25?'âœ…':'âš ï¸'}</small>
        <small><span style="color:#f0883e">â– </span> Fett ${fatPct}% ${fatPct>=25&&fatPct<=35?'âœ…':'âš ï¸'}</small>
        <small><span style="color:#3fb950">â– </span> KH ${carbPct}% ${carbPct>=45&&carbPct<=60?'âœ…':'âš ï¸'}</small>
      </div>
    </div>`;

  // Meal breakdown data for nutrient sources
  const mealBreakdown = s.meal_breakdown || [];
  const nutrientKeyMap = {'Kalorien':'calories','Protein':'protein_g','Fett':'fat_g','Kohlenhydrate':'carbs_g','Ballaststoffe':'fiber_g','Zucker':'sugar_g'};

  const rows = targets.map(({name, unit, val, min, max, goal, icon, note, invert}) => {
    const pct = Math.min(Math.round(val / goal * 100), 150);
    let status, color, badge;
    if (invert) {
      status = val <= max ? 'âœ…' : val <= max*1.2 ? 'âš ï¸' : 'ğŸ”´';
      color = val <= max ? '#3fb950' : val <= max*1.2 ? '#ffc107' : '#f85149';
      badge = val <= max ? 'OK' : 'Zu hoch';
    } else {
      const ok = val >= min && val <= max;
      const low = val < min;
      status = ok ? 'âœ…' : low ? 'ğŸ”µ' : 'âš ï¸';
      color = ok ? '#3fb950' : low ? '#58a6ff' : '#ffc107';
      badge = ok ? 'Optimal' : low ? 'Zu niedrig' : 'Zu hoch';
    }
    const barPct = Math.min(pct, 100);

    // Build per-meal breakdown for this nutrient
    const key = nutrientKeyMap[name];
    let breakdownHTML = '';
    if (key && mealBreakdown.length > 0) {
      const sorted = mealBreakdown.filter(m => m[key] > 0).sort((a,b) => b[key] - a[key]);
      if (sorted.length > 0) {
        const totalVal = val || 1;
        breakdownHTML = `<div class="nutrient-sources" id="src-${key}" style="display:none;margin-top:4px;padding:6px 8px;background:#0d1117;border-radius:6px;font-size:0.8rem">
          ${sorted.map(m => {
            const mVal = Math.round(m[key]*10)/10;
            const mPct = Math.round(m[key]/totalVal*100);
            return `<div class="d-flex justify-content-between align-items-center mb-1">
              <span class="text-muted" style="max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.name}</span>
              <span><strong>${mVal}${unit}</strong> <small class="text-muted">(${mPct}%)</small></span>
            </div>
            <div class="progress mb-1" style="height:4px;background:#21262d"><div class="progress-bar" style="width:${mPct}%;background:${color};opacity:0.7"></div></div>`;
          }).join('')}
        </div>`;
      }
    }

    const toggleAttr = breakdownHTML ? `style="cursor:pointer" onclick="let el=document.getElementById('src-${key}');el.style.display=el.style.display==='none'?'block':'none'"` : '';
    const expandHint = breakdownHTML ? ' <small class="text-muted" style="font-size:0.7rem">â–¶ Details</small>' : '';

    return `
      <div class="mb-2">
        <div class="d-flex justify-content-between align-items-center mb-1" ${toggleAttr}>
          <span>${icon} <strong>${name}</strong>${expandHint}${note ? ' <small class="text-muted">Â· '+note+'</small>' : ''}</span>
          <span>${status} <strong style="color:${color}">${Math.round(val*10)/10}${unit}</strong> <small class="text-muted">/ Ziel ${goal}${unit}</small> <span class="badge ms-1" style="background:${color};color:#000;font-size:0.7rem">${badge}</span></span>
        </div>
        <div class="progress" style="height:8px;background:#21262d">
          <div class="progress-bar" style="width:${barPct}%;background:${color}"></div>
        </div>
        <div class="d-flex justify-content-between mt-1"><small class="text-muted">Min ${min}${unit}</small><small class="text-muted">Max ${max}${unit}</small></div>
        ${breakdownHTML}
      </div>`;
  }).join('');

  // Zuckerwarnung
  const sugarWarn = t.sugar_g > 50 ? `<div class="alert alert-warning py-2 mt-2" style="font-size:0.85rem">âš ï¸ <strong>Zucker:</strong> ${Math.round(t.sugar_g)}g heute â€” deutlich Ã¼ber dem Tagesziel von 50g. GroÃŸteils aus Granatapfelsaft und FrÃ¼chten (natÃ¼rlicher Zucker).</div>` : '';

  const sugarSplitHTML = renderSugarSplit(s);
  document.getElementById('macroDistDisplay').innerHTML = macroDistHTML;
  document.getElementById('nutriAnalysis').innerHTML = rows + sugarSplitHTML + sugarWarn;
}

// === Empfehlungen ===
function renderRecommendations(summary) {
  const t = summary.totals || {};
  const goals = summary.dge_goals || {};
  const prog = summary.micro_progress || {};
  const calProg = summary.progress?.calories || 0;
  const calGoal = summary.goals?.calories || 2000;
  const calLeft = Math.max(0, calGoal - (t.calories || 0));
  const hydration = summary.hydration || {};
  const hydGoal = 2500;
  const hydTotal = hydration.total_ml || 0;
  const hydLeft = Math.max(0, hydGoal - hydTotal);

  // Expected daily supplement contribution (even if not yet logged)
  // These are taken with meals throughout the day
  const suppExpected = {
    zinc_mg: 30,        // Zink 30 Picolinat
    selenium_mcg: 90,   // Selamin
    vitamin_d_iu: 800,  // Curcumin-Loges
    // Omega-3 only Fri-Sun
  };
  // Note: goals from API already use therapeutic targets (prostate/cardio)
  // zinc_mg: 15 (prostata), selenium_mcg: 100 (prostata), vitamin_d_iu: 2000 (prostata)
  // Check what supplements are already logged today
  const suppLogged = (window._allMeals || []).filter(m => m.meal_type === 'supplement');
  const suppAlreadyLogged = {};
  for (const m of suppLogged) {
    for (const k of Object.keys(suppExpected)) {
      suppAlreadyLogged[k] = (suppAlreadyLogged[k] || 0) + (m[k] || 0);
    }
  }
  // Calculate what supplements will still add (not yet taken)
  const suppPending = {};
  for (const [k, v] of Object.entries(suppExpected)) {
    suppPending[k] = Math.max(0, v - (suppAlreadyLogged[k] || 0));
  }
  // Effective totals = current + pending supplements
  const effective = {...t};
  for (const [k, v] of Object.entries(suppPending)) {
    effective[k] = (effective[k] || 0) + v;
  }
  // Effective progress
  const effProg = {};
  for (const k of Object.keys(goals)) {
    effProg[k] = Math.round((effective[k] || 0) / (goals[k] || 1) * 100);
  }

  // Food knowledge base with cross-nutrient profile per food
  // Each food has its primary nutrient (val) plus other nutrients it contains (also)
  const foodDB = {
    vitamin_k_mcg: [
      {name:'Spinat (80g gekocht)',val:444,emoji:'ğŸ¥¬', also:{potassium_mg:420,magnesium_mg:63,iron_mg:2.7,folate_mcg:130,calcium_mg:100,vitamin_c_mg:14}},
      {name:'Brokkoli (100g)',val:140,emoji:'ğŸ¥¦', also:{vitamin_c_mg:65,calcium_mg:47,potassium_mg:316,folate_mcg:63}},
      {name:'Salatmischung (100g)',val:100,emoji:'ğŸ¥—', also:{folate_mcg:30,vitamin_c_mg:12}},
      {name:'Rosenkohl (100g)',val:140,emoji:'ğŸ¥¬', also:{vitamin_c_mg:85,potassium_mg:389,folate_mcg:61}},
    ],
    calcium_mg: [
      {name:'Mineralwasser 0.5L (RÃ¶merquelle)',val:73,emoji:'ğŸ’§', also:{magnesium_mg:27}},
      {name:'Sojamilch 200ml (angereichert)',val:240,emoji:'ğŸ¥›', also:{vitamin_d_iu:40}},
      {name:'Sesam (2 EL, 20g)',val:176,emoji:'ğŸŒ±', also:{iron_mg:2.9,zinc_mg:1.5,magnesium_mg:70}},
      {name:'Feigen getrocknet (50g)',val:80,emoji:'ğŸ‡', also:{potassium_mg:340,magnesium_mg:34,iron_mg:1}},
      {name:'Brokkoli (100g)',val:47,emoji:'ğŸ¥¦', also:{vitamin_c_mg:65,vitamin_k_mcg:140,folate_mcg:63}},
    ],
    magnesium_mg: [
      {name:'Mineralwasser 0.5L (RÃ¶merquelle)',val:27,emoji:'ğŸ’§', also:{calcium_mg:73}},
      {name:'KÃ¼rbiskerne (30g)',val:156,emoji:'ğŸƒ', also:{zinc_mg:2.1,iron_mg:2.5}},
      {name:'Cashews (30g)',val:83,emoji:'ğŸ¥œ', also:{zinc_mg:1.7,iron_mg:1.9}},
      {name:'Spinat (80g)',val:63,emoji:'ğŸ¥¬', also:{vitamin_k_mcg:444,iron_mg:2.7,potassium_mg:420,folate_mcg:130}},
      {name:'Edamame (100g)',val:64,emoji:'ğŸ«›', also:{protein_g:11,iron_mg:2.3,folate_mcg:303,potassium_mg:436}},
    ],
    potassium_mg: [
      {name:'Kartoffel (200g)',val:900,emoji:'ğŸ¥”', also:{vitamin_c_mg:40,magnesium_mg:46,iron_mg:1.6}},
      {name:'Avocado (1/2)',val:485,emoji:'ğŸ¥‘', also:{magnesium_mg:29,folate_mcg:81,vitamin_k_mcg:21}},
      {name:'Spinat (80g)',val:420,emoji:'ğŸ¥¬', also:{vitamin_k_mcg:444,magnesium_mg:63,iron_mg:2.7,folate_mcg:130}},
      {name:'Banane',val:422,emoji:'ğŸŒ', also:{magnesium_mg:32,vitamin_c_mg:10}},
      {name:'Tomatenmark (2 EL)',val:300,emoji:'ğŸ…', also:{iron_mg:1,vitamin_k_mcg:3}},
    ],
    folate_mcg: [
      {name:'Edamame (100g)',val:303,emoji:'ğŸ«›', also:{magnesium_mg:64,iron_mg:2.3,potassium_mg:436}},
      {name:'Spinat (80g)',val:130,emoji:'ğŸ¥¬', also:{vitamin_k_mcg:444,magnesium_mg:63,iron_mg:2.7,potassium_mg:420}},
      {name:'Linsen (100g gekocht)',val:181,emoji:'ğŸ«˜', also:{iron_mg:3.3,potassium_mg:369}},
      {name:'Kichererbsen (100g)',val:172,emoji:'ğŸ«˜', also:{iron_mg:2.9,zinc_mg:1.5,magnesium_mg:48}},
    ],
    iron_mg: [
      {name:'Linsen (100g gekocht)',val:3.3,emoji:'ğŸ«˜', also:{folate_mcg:181,potassium_mg:369}},
      {name:'Spinat (80g)',val:2.7,emoji:'ğŸ¥¬', also:{vitamin_k_mcg:444,magnesium_mg:63,potassium_mg:420,folate_mcg:130}},
      {name:'Sesam (2 EL, 20g)',val:2.9,emoji:'ğŸŒ±', also:{calcium_mg:176,zinc_mg:1.5,magnesium_mg:70}},
      {name:'Haferflocken (50g)',val:2.3,emoji:'ğŸ¥£', also:{magnesium_mg:69,zinc_mg:1.6}},
    ],
    vitamin_c_mg: [
      {name:'Paprika rot (100g)',val:128,emoji:'ğŸ«‘', also:{potassium_mg:175,folate_mcg:10}},
      {name:'Kiwi',val:71,emoji:'ğŸ¥', also:{potassium_mg:252,vitamin_k_mcg:40}},
      {name:'Rosenkohl (100g)',val:85,emoji:'ğŸ¥¬', also:{vitamin_k_mcg:140,potassium_mg:389,folate_mcg:61}},
    ],
    vitamin_d_iu: [
      {name:'Lachs (100g)',val:570,emoji:'ğŸŸ', also:{selenium_mcg:25,potassium_mg:363}},
      {name:'Champignons UV (100g)',val:400,emoji:'ğŸ„', also:{selenium_mcg:9,potassium_mg:318}},
      {name:'Hering (100g)',val:216,emoji:'ğŸŸ', also:{selenium_mcg:37}},
    ],
    zinc_mg: [
      {name:'KÃ¼rbiskerne (30g)',val:2.1,emoji:'ğŸƒ', also:{magnesium_mg:156,iron_mg:2.5}},
      {name:'Cashews (30g)',val:1.7,emoji:'ğŸ¥œ', also:{magnesium_mg:83,iron_mg:1.9}},
      {name:'Linsen (100g)',val:1.3,emoji:'ğŸ«˜', also:{iron_mg:3.3,folate_mcg:181}},
    ],
    selenium_mcg: [
      {name:'ParanÃ¼sse (2 StÃ¼ck)',val:137,emoji:'ğŸ¥œ', also:{magnesium_mg:56,zinc_mg:1.2}},
      {name:'Lachs (100g)',val:25,emoji:'ğŸŸ', also:{vitamin_d_iu:570,potassium_mg:363}},
    ],
  };

  // Helper: check if a food would worsen any already-exceeded nutrient
  function foodConflicts(food, targetKey) {
    const conflicts = [];
    const alsoNutrients = food.also || {};
    for (const [k, addVal] of Object.entries(alsoNutrients)) {
      if (k === targetKey) continue;
      const currentPct = effProg[k] || 0;
      if (currentPct >= 150) {
        // Already well over â€” would this food add significantly? (>10% of goal)
        const goalVal = goals[k] || 1;
        const addPct = (addVal / goalVal) * 100;
        if (addPct > 10) {
          conflicts.push({key: k, name: labels[k]?.[0] || k, addPct: Math.round(addPct)});
        }
      }
    }
    return conflicts;
  }

  let avoidHTML = '';
  let drinkHTML = '';
  let deficits = 0;
  let excesses = 0;

  // Collect ALL recommendations into a single priority-sorted list
  // Priority: lower % = more urgent. Category is just a tag, not a group.
  const allRecs = []; // {pct, category, html, isDeficit}

  const labels = {
    vitamin_c_mg:['Vitamin C','mg'], vitamin_d_iu:['Vitamin D','IU'], vitamin_k_mcg:['Vitamin K','mcg'],
    potassium_mg:['Kalium','mg'], magnesium_mg:['Magnesium','mg'], zinc_mg:['Zink','mg'],
    selenium_mcg:['Selen','mcg'], iron_mg:['Eisen','mg'], calcium_mg:['Calcium','mg'], folate_mcg:['FolsÃ¤ure','mcg']
  };

  // Deficits (<80% DGE) â€” use effective values (incl. pending supplements)
  for (const [key, [name, unit]] of Object.entries(labels)) {
    const pctNow = prog[key] || 0;
    const pctEff = effProg[key] || 0;
    const valEff = effective[key] || 0;
    const goal = goals[key] || 1;
    const missing = goal - valEff;
    const hasPendingSupp = (suppPending[key] || 0) > 0;

    if (pctEff < 80 && missing > 0) {
      deficits++;
      const foods = foodDB[key] || [];
      const safeFoods = [];
      const conflictFoods = [];
      for (const f of foods) {
        const conflicts = foodConflicts(f, key);
        if (conflicts.length === 0) safeFoods.push(f);
        else conflictFoods.push({...f, conflicts});
      }
      const picks = safeFoods.slice(0, 2);
      if (picks.length < 2 && conflictFoods.length > 0) picks.push(conflictFoods[0]);
      if (picks.length > 0) {
        const suggestions = picks.map(f => {
          const base = `${f.emoji} ${f.name} <small class="text-muted">(+${f.val}${unit})</small>`;
          if (f.conflicts && f.conflicts.length > 0) return `${base} <small style="color:#f85149">âš ï¸ erhÃ¶ht ${f.conflicts.map(c=>c.name).join(', ')}</small>`;
          return base;
        }).join(' Â· ');
        const suppNote = hasPendingSupp ? ` <small class="text-muted">(mit Suppl.: ~${Math.round(pctEff)}%)</small>` : '';
        allRecs.push({pct: pctEff, cat:'ğŸ§¬', name, tip: `fehlen ~${Math.round(missing)}${unit} â†’ ${suggestions}`});
      }
    } else if (pctEff >= 80 && pctEff < 100) {
      const foods = foodDB[key] || [];
      if (foods.length > 0 && !hasPendingSupp) {
        const safe = foods.find(f => foodConflicts(f, key).length === 0) || foods[0];
        const conflicts = foodConflicts(safe, key);
        const warn = conflicts.length > 0 ? ` âš ï¸ erhÃ¶ht ${conflicts.map(c=>c.name).join(', ')}` : '';
        allRecs.push({pct: pctEff, cat:'ğŸ§¬', name, tip: `fast da! ${safe.emoji} ${safe.name} reicht${warn}`});
      } else if (hasPendingSupp) {
        allRecs.push({pct: pctEff, cat:'ğŸ’Š', name, tip: `${Math.round(pctNow)}% â†’ ~${Math.round(pctEff)}% mit Supplements âœ…`});
      }
    } else if (pctEff >= 100 && pctNow < 80 && hasPendingSupp) {
      allRecs.push({pct: pctEff, cat:'ğŸ’Š', name, tip: `${Math.round(pctNow)}% â†’ ~${Math.round(pctEff)}% mit Supplements â€” keine Extra-Nahrung nÃ¶tig`});
    }

    if (pctEff > 300) {
      excesses++;
      avoidHTML += `<div class="mb-1"><span style="color:#f85149">ğŸ”´ ${name}: ${Math.round(pctEff)}%</span> â€” stark Ã¼berschritten, keine weiteren ${name}-reichen Lebensmittel nÃ¶tig</div>`;
    }
  }

  // Macro limits â€” sugar & fat warnings
  const sugarTotal = t.sugar_g || 0;
  const sugarAdded = t.sugar_added_g || 0;
  if (sugarAdded > 25) {
    excesses++;
    avoidHTML += `<div class="mb-1"><span style="color:#f85149">ğŸ”´ Zugesetzter Zucker: ${Math.round(sugarAdded)}g</span> â€” WHO-Limit (25g) Ã¼berschritten!</div>`;
  } else if (sugarTotal > 50) {
    avoidHTML += `<div class="mb-1"><span style="color:#ffc107">ğŸŸ¡ Gesamt-Zucker: ${Math.round(sugarTotal)}g</span> â€” bereits hoch, Obst-Zucker bewusst dosieren</div>`;
  }

  const satfat = t.saturated_fat_g || 0;
  if (satfat > 20) {
    avoidHTML += `<div class="mb-1"><span style="color:#f85149">ğŸ”´ GesÃ¤ttigtes Fett: ${Math.round(satfat)}g</span> â€” DGE max ~20g</div>`;
  }

  // Hydration
  if (hydLeft > 500) {
    drinkHTML += `<div class="mb-1">ğŸ’§ Noch <strong>${Math.round(hydLeft)}ml</strong> trinken (${Math.round(hydLeft/250)} GlÃ¤ser)</div>`;
    // Suggest mineral water for calcium/magnesium
    const caPct = prog.calcium_mg || 0;
    const mgPct = prog.magnesium_mg || 0;
    if (caPct < 100 || mgPct < 100) {
      drinkHTML += `<div class="mb-1">ğŸ’§ Tipp: <strong>Mineralwasser</strong> (RÃ¶merquelle) deckt auch Calcium + Magnesium ab!</div>`;
    }
  } else if (hydLeft > 0) {
    drinkHTML += `<div class="mb-1">ğŸ’§ Fast geschafft! Noch <strong>${Math.round(hydLeft)}ml</strong> (${Math.ceil(hydLeft/250)} Glas)</div>`;
  }
  // If hydration goal reached â†’ don't show the section at all

  // === Prostata & Herz-Kreislauf Substanzen ===
  const prostate = window._prostateData || {};
  const cardio = window._cardioData || {};

  const substanceFoods = {
    'lycopin_mg': [{name:'Tomatenmark (2 EL)',emoji:'ğŸ…'},{name:'Tomaten gekocht (200g)',emoji:'ğŸ…'}],
    'vitamin_d_iu': [{name:'Lachs (100g)',emoji:'ğŸŸ'},{name:'Champignons UV (100g)',emoji:'ğŸ„'}],
    'omega3_epa_dha_mg': [{name:'Lachs (100g, ~2000mg)',emoji:'ğŸŸ'},{name:'Hering (100g, ~1700mg)',emoji:'ğŸŸ'}],
    'punicalagin_mg': [{name:'Granatapfelsaft (250ml)',emoji:'ğŸ·'}],
    'caffeine_mg': [{name:'GrÃ¼ner Tee (Tasse)',emoji:'ğŸµ'},{name:'Kaffee (Tasse)',emoji:'â˜•'}],
  };

  for (const sub of (prostate.substances || [])) {
    const pct = Math.round(sub.total / sub.optimal_min * 100);
    if (sub.status === 'low' || pct < 80) {
      deficits++;
      const missing = sub.optimal_min - sub.total;
      const foods = substanceFoods[sub.key] || [];
      const foodTip = foods.length > 0 ? ` â†’ ${foods.map(f => `${f.emoji} ${f.name}`).join(', ')}` : '';
      allRecs.push({pct, cat:'ğŸ¯', name: sub.name, tip: `${Math.round(sub.total)}/${sub.optimal_min} ${sub.unit} â€” fehlen ~${Math.round(missing)} ${sub.unit}${foodTip}`, html:''});
    } else if (sub.status === 'high') {
      const overBy = sub.total - sub.optimal_max;
      if (overBy > 0) {
        excesses++;
        avoidHTML += `<div class="mb-1"><span style="color:#ffc107">ğŸŸ¡ ${sub.name}: ${Math.round(sub.total)} ${sub.unit}</span> â€” Ã¼ber Optimal (${sub.optimal_min}-${sub.optimal_max}), nicht weiter erhÃ¶hen</div>`;
      }
    }
  }

  const prostateKeys = new Set((prostate.substances || []).map(s => s.key));
  for (const sub of (cardio.substances || [])) {
    if (prostateKeys.has(sub.key)) continue;
    const pct = Math.round(sub.total / sub.optimal_min * 100);
    if (sub.status === 'low' || pct < 80) {
      deficits++;
      const missing = sub.optimal_min - sub.total;
      allRecs.push({pct, cat:'â¤ï¸', name: sub.name, tip: `${Math.round(sub.total)}/${sub.optimal_min} ${sub.unit} â€” fehlen ~${Math.round(missing)} ${sub.unit}`, html:''});
    } else if (sub.status === 'high') {
      const overBy = sub.total - sub.optimal_max;
      if (overBy > 0 && !avoidHTML.includes(sub.name)) {
        excesses++;
        avoidHTML += `<div class="mb-1"><span style="color:#ffc107">ğŸŸ¡ ${sub.name}: ${Math.round(sub.total)} ${sub.unit}</span> â€” Ã¼ber Optimal (${sub.optimal_min}-${sub.optimal_max})</div>`;
      }
    }
  }

  // === MakronÃ¤hrstoffe ===
  const goals_macro = summary.goals || {};
  const protPct = Math.round((t.protein_g || 0) / (goals_macro.protein_g || 100) * 100);
  const fiberPct = Math.round((t.fiber_g || 0) / (goals_macro.fiber_g || 30) * 100);

  if (protPct < 80) {
    deficits++;
    const protLeft = (goals_macro.protein_g || 100) - (t.protein_g || 0);
    allRecs.push({pct: protPct, cat:'ğŸ½ï¸', name: 'Protein', tip: `noch ~${Math.round(protLeft)}g â†’ Linsen, Tofu, Edamame, Lachs`});
  }
  if (fiberPct < 80) {
    deficits++;
    const fiberLeft = (goals_macro.fiber_g || 30) - (t.fiber_g || 0);
    allRecs.push({pct: fiberPct, cat:'ğŸ½ï¸', name: 'Ballaststoffe', tip: `noch ~${Math.round(fiberLeft)}g â†’ Vollkorn, HÃ¼lsenfrÃ¼chte, GemÃ¼se`});
  }
  if (calLeft > 0 && calLeft < 500) {
    allRecs.push({pct: 90, cat:'ğŸ½ï¸', name: 'Kalorien', tip: `noch ${Math.round(calLeft)} kcal â€” leichter Snack reicht`});
  } else if (calLeft >= 500) {
    allRecs.push({pct: 50, cat:'ğŸ½ï¸', name: 'Kalorien', tip: `noch ${Math.round(calLeft)} kcal â€” eine vollwertige Mahlzeit passt noch`});
  } else if (calLeft <= 0) {
    avoidHTML += `<div class="mb-1"><span style="color:#ffc107">ğŸŸ¡ Kalorienziel erreicht (${Math.round(t.calories)} / ${calGoal} kcal)</span></div>`;
  }

  // Sort all recommendations by priority (lowest % = most urgent first)
  allRecs.sort((a, b) => a.pct - b.pct);

  // Build accordions â€” all collapsed by default
  let html = '';

  if (allRecs.length === 0 && !avoidHTML && hydLeft <= 0) {
    html = `<div class="text-center" style="color:#3fb950;font-size:1.1rem">âœ… Alles im grÃ¼nen Bereich! Perfekter Tag.</div>`;
  } else {
    // Count items per section for summary badges
    const deficitCount = allRecs.filter(r => r.pct < 80).length;
    const nearCount = allRecs.filter(r => r.pct >= 80).length;

    const urgentRecs = allRecs.filter(r => r.pct < 80);
    const nearRecs = allRecs.filter(r => r.pct >= 80);

    // Helper: render a rec row as compact card-style
    function recRow(r) {
      const barColor = r.pct < 50 ? '#f85149' : r.pct < 80 ? '#f0883e' : r.pct < 100 ? '#58a6ff' : '#3fb950';
      const barW = Math.min(r.pct, 100);
      return `<div class="d-flex align-items-center px-3 py-2" style="border-bottom:1px solid rgba(255,255,255,0.04)">
        <span style="font-size:0.75rem;width:24px;flex-shrink:0">${r.cat}</span>
        <div style="flex:1;min-width:0">
          <div class="d-flex justify-content-between align-items-center">
            <span style="font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.name}</span>
            <span style="font-size:0.82rem;white-space:nowrap;margin-left:8px"><strong style="color:${barColor}">${Math.round(r.pct)}%</strong></span>
          </div>
          <div class="progress mt-1" style="height:4px;background:#21262d"><div class="progress-bar" style="width:${barW}%;background:${barColor}"></div></div>
          <div style="font-size:0.78rem;color:#8b949e;margin-top:2px">${r.tip}</div>
        </div>
      </div>`;
    }

    if (urgentRecs.length > 0) {
      html += `<div class="meal-card mb-2 p-0" style="overflow:hidden;border-color:#f0883e">
        <div class="d-flex justify-content-between align-items-center px-3 py-2" style="cursor:pointer" onclick="toggleAcc('recImprove')">
          <div><strong style="color:#f0883e">ğŸ“‹ Heute noch verbessern</strong> <span class="text-muted ms-2" style="font-size:0.85rem">${urgentRecs.length} LÃ¼cken</span></div>
          <span id="recImprove-icon" style="transition:transform 0.2s">â–¼</span>
        </div>
        <div id="recImprove" style="display:none;border-top:1px solid rgba(255,255,255,0.08)">${urgentRecs.map(recRow).join('')}</div>
      </div>`;
    }

    if (nearRecs.length > 0) {
      html += `<div class="meal-card mb-2 p-0" style="overflow:hidden;border-color:#58a6ff">
        <div class="d-flex justify-content-between align-items-center px-3 py-2" style="cursor:pointer" onclick="toggleAcc('recNear')">
          <div><strong style="color:#58a6ff">ğŸ”µ Fast da</strong> <span class="text-muted ms-2" style="font-size:0.85rem">${nearRecs.length} EintrÃ¤ge</span></div>
          <span id="recNear-icon" style="transition:transform 0.2s">â–¼</span>
        </div>
        <div id="recNear" style="display:none;border-top:1px solid rgba(255,255,255,0.08)">${nearRecs.map(recRow).join('')}</div>
      </div>`;
    }

    if (drinkHTML) {
      html += `<div class="meal-card mb-2 p-0" style="overflow:hidden;border-color:#58a6ff">
        <div class="d-flex justify-content-between align-items-center px-3 py-2" style="cursor:pointer" onclick="toggleAcc('recDrink')">
          <div><strong style="color:#58a6ff">ğŸš° FlÃ¼ssigkeit</strong> <span class="text-muted ms-2" style="font-size:0.85rem">${hydLeft > 0 ? Math.round(hydLeft)+'ml Ã¼brig' : 'âœ… erreicht'}</span></div>
          <span id="recDrink-icon" style="transition:transform 0.2s">â–¼</span>
        </div>
        <div id="recDrink" style="display:none;border-top:1px solid rgba(255,255,255,0.08)">
          <div class="px-3 py-2" style="font-size:0.85rem">${drinkHTML}</div>
        </div>
      </div>`;
    }

    if (avoidHTML) {
      html += `<div class="meal-card mb-2 p-0" style="overflow:hidden;border-color:#f85149">
        <div class="d-flex justify-content-between align-items-center px-3 py-2" style="cursor:pointer" onclick="toggleAcc('recAvoid')">
          <div><strong style="color:#f85149">â›” Genug davon</strong> <span class="text-muted ms-2" style="font-size:0.85rem">${excesses} Ãœberschreitungen</span></div>
          <span id="recAvoid-icon" style="transition:transform 0.2s">â–¼</span>
        </div>
        <div id="recAvoid" style="display:none;border-top:1px solid rgba(255,255,255,0.08)">
          <div class="px-3 py-2" style="font-size:0.85rem">${avoidHTML}</div>
        </div>
      </div>`;
    }
  }

  document.getElementById('recsContent').innerHTML = html;
  document.getElementById('recsCard').style.display = '';
  document.getElementById('recsSummary').textContent = `${deficits} LÃ¼cken Â· ${excesses} Ãœberschreitungen`;
}

// === Hydration ===
function renderHydration(h) {
  if (!h) { document.getElementById('hydrationDisplay').innerHTML = ''; return; }
  const pct = Math.min(Math.round(h.total_ml / h.goal_ml * 100), 100);
  const color = pct >= 80 ? '#3fb950' : pct >= 50 ? '#ffc107' : '#58a6ff';
  const status = pct >= 100 ? 'âœ…' : pct >= 80 ? 'ğŸ”µ' : 'âš ï¸';
  const liters = (h.total_ml / 1000).toFixed(1);
  const goalL = (h.goal_ml / 1000).toFixed(1);
  const entries = h.entries || [];
  const typeIcons = {water:'ğŸ’§',tea:'ğŸµ',coffee:'â˜•',juice:'ğŸ§ƒ',other:'ğŸ¥¤'};
  const entriesHTML = entries.length > 0 ? `
    <div id="hydrationEntries" style="display:none;margin-top:6px;padding:6px 8px;background:#0d1117;border-radius:6px;font-size:0.8rem">
      ${entries.map(e => {
        const icon = typeIcons[e.drink_type] || 'ğŸ¥¤';
        const time = e.created_at ? e.created_at.split(' ')[1]?.substring(0,5) : '';
        const ePct = Math.round(e.amount_ml / (h.total_ml||1) * 100);
        return `<div class="d-flex justify-content-between align-items-center mb-1">
          <span>${icon} <span class="text-muted">${e.description || e.drink_type}</span> ${time ? '<small class="text-muted">'+time+'</small>' : ''}</span>
          <span><strong>${e.amount_ml}ml</strong> <small class="text-muted">(${ePct}%)</small>
            <span class="text-danger ms-1" style="cursor:pointer;font-size:0.7rem" onclick="deleteHydration(${e.id})">âœ•</span></span>
        </div>
        <div class="progress mb-1" style="height:3px;background:#21262d"><div class="progress-bar" style="width:${ePct}%;background:${color};opacity:0.6"></div></div>`;
      }).join('')}
    </div>` : '';
  const detailToggle = entries.length > 0 ? ` <small class="text-muted" style="cursor:pointer;font-size:0.7rem" onclick="let el=document.getElementById('hydrationEntries');el.style.display=el.style.display==='none'?'block':'none'">â–¶ ${entries.length} EintrÃ¤ge</small>` : '';
  document.getElementById('hydrationDisplay').innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-1">
      <span>${status} <strong style="color:${color}">${liters}L</strong> <small class="text-muted">/ ${goalL}L Ziel</small>${detailToggle}</span>
      <span class="badge" style="background:${color};color:#000;font-size:0.75rem">${pct}%</span>
    </div>
    <div class="progress" style="height:10px;background:#21262d">
      <div class="progress-bar" style="width:${pct}%;background:${color}"></div>
    </div>
    ${entriesHTML}`;
}

async function deleteHydration(id) {
  await fetch('/api/hydration/' + id, {method:'DELETE'});
  loadAll();
}

async function addQuickWater(ml) {
  await fetch('/api/hydration', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({date: currentDate, amount_ml: ml, drink_type: 'water', description: `Wasser ${ml}ml`})});
  loadAll();
}

function showHydrationModal() {
  new bootstrap.Modal(document.getElementById('hydrationModal')).show();
}

async function addHydration() {
  const amount = parseInt(document.getElementById('hAmount').value) || 250;
  const drink_type = document.getElementById('hType').value;
  const desc = document.getElementById('hDesc').value || `${document.getElementById('hType').selectedOptions[0].text} ${amount}ml`;
  await fetch('/api/hydration', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({date: currentDate, amount_ml: amount, drink_type, description: desc})});
  bootstrap.Modal.getInstance(document.getElementById('hydrationModal')).hide();
  loadAll();
}

function renderWeek(w) {
  const canvas = document.getElementById('weekChart'), ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2, H = canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2,2); const cw=W/2, ch=H/2;
  ctx.clearRect(0,0,cw,ch);
  const max = Math.max(2025, ...w.days.map(d=>d.calories)) * 1.1;
  const barW = (cw-60)/7, pad = 8;
  w.days.forEach((d,i) => {
    const x = 40 + i*barW, h2 = (d.calories/max)*(ch-40);
    const color = d.calories > 2025 ? '#f85149' : '#3fb950';
    ctx.fillStyle = color; ctx.fillRect(x+pad, ch-25-h2, barW-pad*2, h2);
    ctx.fillStyle = '#8b949e'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(d.date.slice(5), x+barW/2, ch-8);
    if (d.calories > 0) { ctx.fillStyle='#c9d1d9'; ctx.fillText(Math.round(d.calories), x+barW/2, ch-30-h2); }
  });
  // goal line
  const goalY = ch - 25 - (2025/max)*(ch-40);
  ctx.strokeStyle = '#f0883e'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(40,goalY); ctx.lineTo(cw-20,goalY); ctx.stroke();
  ctx.setLineDash([]); ctx.fillStyle='#f0883e'; ctx.font='9px sans-serif'; ctx.textAlign='left'; ctx.fillText('2025', 2, goalY+3);
}

let editComponents = [];

function addCompRow(comp) {
  const list = document.getElementById('compList');
  const idx = list.children.length;
  const div = document.createElement('div');
  div.className = 'row g-1 mb-1 align-items-center';
  div.innerHTML = `
    <div class="col-4"><input class="form-control form-control-sm comp-desc" placeholder="Zutat" value="${comp?.description||''}"></div>
    <div class="col-2"><input type="number" step="any" class="form-control form-control-sm comp-cal" placeholder="kcal" value="${comp?.calories||''}"></div>
    <div class="col-1"><input type="number" step="any" class="form-control form-control-sm comp-prot" placeholder="P" value="${comp?.protein_g||''}"></div>
    <div class="col-1"><input type="number" step="any" class="form-control form-control-sm comp-fat" placeholder="F" value="${comp?.fat_g||''}"></div>
    <div class="col-1"><input type="number" step="any" class="form-control form-control-sm comp-carbs" placeholder="KH" value="${comp?.carbs_g||''}"></div>
    <div class="col-1"><button class="btn btn-sm btn-outline-danger py-0" onclick="this.closest('.row').remove()">Ã—</button></div>`;
  list.appendChild(div);
}

function getCompRows() {
  return [...document.querySelectorAll('#compList .row')].map(row => ({
    description: row.querySelector('.comp-desc').value,
    calories: parseFloat(row.querySelector('.comp-cal').value)||0,
    protein_g: parseFloat(row.querySelector('.comp-prot').value)||0,
    fat_g: parseFloat(row.querySelector('.comp-fat').value)||0,
    carbs_g: parseFloat(row.querySelector('.comp-carbs').value)||0,
  })).filter(c => c.description.trim());
}

let allMeals = [];
function showAddModal() {
  document.getElementById('mealId').value = '';
  document.getElementById('mDate').value = currentDate;
  document.getElementById('mealForm').reset();
  document.getElementById('mDate').value = currentDate;
  document.getElementById('compList').innerHTML = '';
  document.getElementById('modalTitle').textContent = 'Mahlzeit hinzufÃ¼gen';
  new bootstrap.Modal(document.getElementById('mealModal')).show();
}

async function editMeal(id) {
  const meal = await fetch(`${API}/api/meals?date=${currentDate}`).then(r=>r.json()).then(ms=>ms.find(m=>m.id===id));
  if (!meal) return;
  document.getElementById('mealId').value = id;
  document.getElementById('mType').value = meal.meal_type;
  document.getElementById('mDate').value = meal.date;
  document.getElementById('mDesc').value = meal.description;
  document.getElementById('mCal').value = meal.calories;
  document.getElementById('mProt').value = meal.protein_g;
  document.getElementById('mFat').value = meal.fat_g;
  document.getElementById('mCarbs').value = meal.carbs_g;
  document.getElementById('mFiber').value = meal.fiber_g;
  document.getElementById('mSugar').value = meal.sugar_g;
  document.getElementById('mSugarNat').value = meal.sugar_natural_g || '';
  document.getElementById('mSugarAdd').value = meal.sugar_added_g || '';
  document.getElementById('mVitC').value = meal.vitamin_c_mg || '';
  document.getElementById('mVitD').value = meal.vitamin_d_iu || '';
  document.getElementById('mVitK').value = meal.vitamin_k_mcg || '';
  document.getElementById('mPotassium').value = meal.potassium_mg || '';
  document.getElementById('mMagnesium').value = meal.magnesium_mg || '';
  document.getElementById('mZinc').value = meal.zinc_mg || '';
  document.getElementById('mSelenium').value = meal.selenium_mcg || '';
  document.getElementById('mIron').value = meal.iron_mg || '';
  document.getElementById('mCalcium').value = meal.calcium_mg || '';
  document.getElementById('mFolate').value = meal.folate_mcg || '';
  document.getElementById('mNotes').value = meal.notes;
  // Load components
  document.getElementById('compList').innerHTML = '';
  if (meal.components && meal.components.length > 0) {
    meal.components.forEach(c => addCompRow(c));
  }
  document.getElementById('modalTitle').textContent = 'Mahlzeit bearbeiten';
  new bootstrap.Modal(document.getElementById('mealModal')).show();
}

async function saveMeal() {
  const id = document.getElementById('mealId').value;
  const data = {
    date: document.getElementById('mDate').value,
    meal_type: document.getElementById('mType').value,
    description: document.getElementById('mDesc').value,
    calories: parseFloat(document.getElementById('mCal').value)||0,
    protein_g: parseFloat(document.getElementById('mProt').value)||0,
    fat_g: parseFloat(document.getElementById('mFat').value)||0,
    carbs_g: parseFloat(document.getElementById('mCarbs').value)||0,
    fiber_g: parseFloat(document.getElementById('mFiber').value)||0,
    sugar_g: parseFloat(document.getElementById('mSugar').value)||0,
    sugar_natural_g: parseFloat(document.getElementById('mSugarNat').value)||0,
    sugar_added_g: parseFloat(document.getElementById('mSugarAdd').value)||0,
    vitamin_c_mg: parseFloat(document.getElementById('mVitC').value)||0,
    vitamin_d_iu: parseFloat(document.getElementById('mVitD').value)||0,
    vitamin_k_mcg: parseFloat(document.getElementById('mVitK').value)||0,
    potassium_mg: parseFloat(document.getElementById('mPotassium').value)||0,
    magnesium_mg: parseFloat(document.getElementById('mMagnesium').value)||0,
    zinc_mg: parseFloat(document.getElementById('mZinc').value)||0,
    selenium_mcg: parseFloat(document.getElementById('mSelenium').value)||0,
    iron_mg: parseFloat(document.getElementById('mIron').value)||0,
    calcium_mg: parseFloat(document.getElementById('mCalcium').value)||0,
    folate_mcg: parseFloat(document.getElementById('mFolate').value)||0,
    notes: document.getElementById('mNotes').value,
    source: 'manual'
  };
  const url = id ? `${API}/api/meals/${id}` : `${API}/api/meals`;
  const resp = await fetch(url, {method: id?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
  const saved = await resp.json();
  const mealId = id || saved.id;
  // Save components: delete existing, re-add
  const comps = getCompRows();
  if (mealId) {
    // Delete old components
    const oldComps = await fetch(`${API}/api/meals/${mealId}/components`).then(r=>r.json());
    for (const c of oldComps) await fetch(`${API}/api/meals/${mealId}/components/${c.id}`, {method:'DELETE'});
    // Add new
    for (let i=0; i<comps.length; i++) {
      await fetch(`${API}/api/meals/${mealId}/components`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({...comps[i], sort_order:i})});
    }
  }
  bootstrap.Modal.getInstance(document.getElementById('mealModal')).hide();
  loadAll();
  loadProstataAnalysis();
  loadCardioAnalysis();
  loadCaffeine();
}

async function deleteMeal(id) {
  if (!confirm('Mahlzeit lÃ¶schen?')) return;
  await fetch(`${API}/api/meals/${id}`, {method:'DELETE'});
  loadAll();
  loadProstataAnalysis();
  loadCardioAnalysis();
  loadCaffeine();
}

// === Supplements ===
async function loadSupplements() {
  const data = await fetch(`${API}/api/supplement-intake/${currentDate}`).then(r => r.json());
  // Count total doses and taken doses
  let totalDoses = 0, takenDoses = 0;
  data.forEach(s => {
    s.doses.forEach(d => { totalDoses++; if (d.taken) takenDoses++; });
  });
  document.getElementById('suppProgress').textContent = `${takenDoses} / ${totalDoses} Dosen heute eingenommen`;
  const pct = totalDoses > 0 ? Math.round(takenDoses / totalDoses * 100) : 0;
  const bar = document.getElementById('suppBar');
  bar.style.width = pct + '%';
  bar.className = 'progress-bar ' + (pct === 100 ? 'bg-success' : 'bg-info');

  const slotLabels = {morning:'â˜€ï¸ Morgens', noon:'ğŸŒ¤ï¸ Mittags', evening:'ğŸŒ™ Abends'};
  const slotOrder = ['morning', 'noon', 'evening'];

  // Build flat list: one entry per supplement per dose slot
  const entries = [];
  data.forEach(s => {
    s.doses.forEach(d => {
      entries.push({...s, slot: d.dose_slot, taken: d.taken, doseId: d.id});
    });
  });

  // Group by slot
  let html = '<div class="list-group list-group-flush">';
  slotOrder.forEach(slot => {
    const group = entries.filter(e => e.slot === slot);
    if (group.length === 0) return;
    html += `<div class="list-group-item px-2 py-1" style="background:rgba(255,255,255,0.03);border-color:rgba(255,255,255,0.08)">
      <strong style="font-size:0.85rem">${slotLabels[slot]}</strong></div>`;
    group.forEach(e => {
      const catBadges = {prostata:'ğŸ¯ Prostata',leber:'ğŸ›¡ï¸ Leberschutz',herz:'â¤ï¸ Herz-Kreislauf',entzÃ¼ndung:'ğŸ”¥ EntzÃ¼ndungshemmend',antioxidans:'ğŸµ Antioxidans',vitamin:'ğŸ’Š Vitamin'};
      let badges = '';
      if (e.category && catBadges[e.category]) badges += ` <span class="badge" style="font-size:0.65rem;background:rgba(255,255,255,0.1)">${catBadges[e.category]}</span>`;
      if (e.prostate_relevant && e.category !== 'prostata') badges += ` <span class="badge bg-info" style="font-size:0.65rem">ğŸ¯ Prostata</span>`;
      const doseCountKey = 'dose_' + e.slot;
      const doseCount = e[doseCountKey] || 1;
      const countLabel = doseCount > 1 ? ` ${doseCount} Kaps.` : ` 1 ${e.unit}`;
      html += `
        <div class="list-group-item d-flex align-items-center px-2 py-2" style="background:transparent;border-color:rgba(255,255,255,0.05)">
          <div class="form-check me-2" style="min-width:30px">
            <input class="form-check-input" type="checkbox" id="supp-${e.supplement_id}-${e.slot}"
              ${e.taken ? 'checked' : ''} onchange="toggleSupplement(${e.supplement_id}, '${e.slot}', this.checked)">
          </div>
          <div style="flex:1">
            <span style="font-size:0.9rem"><strong>${e.name}</strong>${badges}</span>
            <small class="text-muted ms-1">${countLabel}</small>
          </div>
        </div>`;
    });
  });
  html += '</div>';
  document.getElementById('suppList').innerHTML = html;
}

async function toggleSupplement(suppId, doseSlot, taken) {
  await fetch(`${API}/api/supplement-intake`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({date: currentDate, supplement_id: suppId, dose_slot: doseSlot, taken: taken ? 1 : 0})
  });
  loadSupplements();
  loadProstataAnalysis();
  loadCardioAnalysis();
  loadCaffeine();
}

// === Prostata-Analyse ===
async function loadProstataAnalysis() {
  try {
    const data = await fetch(`${API}/api/prostate-analysis/${currentDate}`).then(r => r.json());
    renderProstataAnalysis(data);
  } catch (e) {
    console.error('Prostata analysis error:', e);
  }
}

// Severity color: 0=green/yellow, 0.5=orange, 1.0=red
function severityColor(sev) {
  sev = Math.max(0, Math.min(1, sev));
  if (sev < 0.15) return '#ffc107'; // yellow â€” barely outside
  if (sev < 0.35) return '#ff9800'; // orange â€” moderately outside
  if (sev < 0.6)  return '#f44336'; // red â€” significantly outside
  return '#d32f2f'; // dark red â€” far outside
}

function renderProstataAnalysis(data) {
  const tbody = document.getElementById('prostataTableBody');
  if (!data || !data.substances || data.substances.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">Keine Daten</td></tr>';
    return;
  }

  let html = '';
  data.substances.forEach(s => {
    // Status badge with gradient severity coloring
    let badge;
    if (s.status === 'optimal') {
      badge = '<span class="badge bg-success">âœ… Optimal</span>';
    } else if (s.status === 'low' || s.status === 'high') {
      const sev = s.severity || 0;
      const bg = severityColor(sev);
      const icon = s.status === 'high' ? 'â†‘' : 'â†“';
      const label = s.status === 'high' ? 'Zu hoch' : 'Zu niedrig';
      const sevPct = Math.round(sev * 100);
      badge = `<span class="badge" style="background:${bg};color:#000">${icon} ${label} <small>(${sevPct}%)</small></span>`;
    } else {
      badge = '<span class="badge bg-secondary">â€”</span>';
    }

    // Amount display
    const amount = s.total > 0 ? `${s.total} ${s.unit}` : 'â€”';

    // Sources
    const sources = s.sources.length > 0 ? s.sources.join('<br>') : '<span class="text-muted">â€”</span>';

    // Breakdown (supplements + food)
    let breakdown = '';
    if (s.total > 0) {
      const parts = [];
      if (s.from_supplements > 0) parts.push(`ğŸ’Š ${s.from_supplements}${s.unit}`);
      if (s.from_food > 0) parts.push(`ğŸ¥— ${s.from_food}${s.unit}`);
      breakdown = parts.length > 0 ? `<br><small class="text-muted">${parts.join(' + ')}</small>` : '';
    }

    html += `<tr>
      <td><strong>${s.name}</strong></td>
      <td style="font-size:0.8rem">${sources}</td>
      <td>${amount}${breakdown}</td>
      <td>${s.optimal_min}â€“${s.optimal_max} ${s.unit}</td>
      <td>${badge}</td>
    </tr>`;
  });

  tbody.innerHTML = html;

  // Update collapsed header badges
  const alerts = data.substances.filter(s => s.status !== 'optimal' && s.status !== 'none' && s.total > 0);
  const noData = data.substances.filter(s => s.status === 'none' || s.total === 0);
  let alertHtml = alerts.map(s => {
    const icon = s.status === 'high' ? 'â†‘' : 'â†“';
    const bg = severityColor(s.severity || 0);
    return `<span class="badge" style="font-size:0.7rem;background:${bg};color:#000">${icon} ${s.name}</span>`;
  }).join('');
  // Add count of missing if any
  if (noData.length > 0) {
    alertHtml += `<span class="badge bg-secondary" style="font-size:0.7rem">${noData.length} nicht eingenommen</span>`;
  }
  // If all taken and optimal
  if (alerts.length === 0 && noData.length === 0) {
    alertHtml = '<span class="badge bg-success" style="font-size:0.7rem">âœ… Alles optimal</span>';
  }
  document.getElementById('prostataAlerts').innerHTML = alertHtml;
}

// === Herz-Kreislauf Analyse ===
async function loadCardioAnalysis() {
  try {
    const data = await fetch(`${API}/api/cardio-analysis/${currentDate}`).then(r => r.json());
    renderCardioAnalysis(data);
  } catch (e) {
    console.error('Cardio analysis error:', e);
  }
}

function renderCardioAnalysis(data) {
  const tbody = document.getElementById('cardioTableBody');
  if (!data || !data.substances || data.substances.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">Keine Daten</td></tr>';
    return;
  }

  let html = '';
  data.substances.forEach(s => {
    let badge;
    if (s.status === 'optimal') {
      badge = '<span class="badge bg-success">âœ… Optimal</span>';
    } else if (s.status === 'low' || s.status === 'high') {
      const sev = s.severity || 0;
      const bg = severityColor(sev);
      const icon = s.status === 'high' ? 'â†‘' : 'â†“';
      const label = s.status === 'high' ? 'Zu hoch' : 'Zu niedrig';
      const sevPct = Math.round(sev * 100);
      badge = `<span class="badge" style="background:${bg};color:#000">${icon} ${label} <small>(${sevPct}%)</small></span>`;
    } else {
      badge = '<span class="badge bg-secondary">â€”</span>';
    }

    const amount = s.total > 0 ? `${s.total} ${s.unit}` : 'â€”';
    const sources = s.sources.length > 0 ? s.sources.join('<br>') : '<span class="text-muted">â€”</span>';

    let breakdown = '';
    if (s.total > 0) {
      const parts = [];
      if (s.from_supplements > 0) parts.push(`ğŸ’Š ${s.from_supplements}${s.unit}`);
      if (s.from_food > 0) parts.push(`ğŸ¥— ${s.from_food}${s.unit}`);
      breakdown = parts.length > 0 ? `<br><small class="text-muted">${parts.join(' + ')}</small>` : '';
    }

    const note = s.note ? `<small class="text-muted">${s.note}</small>` : '';

    html += `<tr>
      <td><strong>${s.name}</strong></td>
      <td style="font-size:0.8rem">${sources}</td>
      <td>${amount}${breakdown}</td>
      <td>${s.optimal_min}â€“${s.optimal_max} ${s.unit}</td>
      <td>${badge}</td>
      <td style="font-size:0.8rem">${note}</td>
    </tr>`;
  });

  tbody.innerHTML = html;

  // Update collapsed header badges
  const alerts = data.substances.filter(s => s.status !== 'optimal' && s.status !== 'none' && s.total > 0);
  const noData = data.substances.filter(s => s.status === 'none' || s.total === 0);
  let alertHtml = alerts.map(s => {
    const icon = s.status === 'high' ? 'â†‘' : 'â†“';
    const bg = severityColor(s.severity || 0);
    return `<span class="badge" style="font-size:0.7rem;background:${bg};color:#000">${icon} ${s.name}</span>`;
  }).join('');
  if (noData.length > 0) {
    alertHtml += `<span class="badge bg-secondary" style="font-size:0.7rem">${noData.length} nicht eingenommen</span>`;
  }
  if (alerts.length === 0 && noData.length === 0) {
    alertHtml = '<span class="badge bg-success" style="font-size:0.7rem">âœ… Alles optimal</span>';
  }
  document.getElementById('cardioAlerts').innerHTML = alertHtml;
}

async function loadCaffeine() {
  try {
    const data = await fetch(`${API}/api/prostate-analysis/${currentDate}`).then(r => r.json());
    const caffeine = data.substances.find(s => s.key === 'caffeine_mg');
    if (!caffeine) return;
    const total = caffeine.total || 0;
    const maxVal = 400;
    document.getElementById('caffeineText').textContent = `${Math.round(total)} / ${maxVal} mg`;
    const bar = document.getElementById('caffeineBar');
    const pct = Math.min(Math.round(total / maxVal * 100), 100);
    bar.style.width = pct + '%';
    if (total > maxVal) {
      bar.style.background = '#f85149'; // red â€” over limit
    } else if (total >= 300) {
      bar.style.background = '#3fb950'; // green â€” optimal (Harvard: 3+ cups)
    } else if (total >= 150) {
      bar.style.background = '#ffc107'; // yellow â€” ok but below Harvard target
    } else {
      bar.style.background = '#6c757d'; // grey â€” under target
    }
  } catch (e) {
    console.error('Caffeine load error:', e);
  }
}

// === MikronÃ¤hrstoffe ===
function renderMicronutrients(summary) {
  const t = summary.totals || {};
  const goals = summary.dge_goals || {};
  const prog = summary.micro_progress || {};
  const labels = {
    vitamin_c_mg: ['Vitamin C', 'mg', '#f0883e'],
    vitamin_d_iu: ['Vitamin D', 'IU', '#ffc107'],
    vitamin_k_mcg: ['Vitamin K', 'mcg', '#bc8cff'],
    potassium_mg: ['Kalium', 'mg', '#58a6ff'],
    magnesium_mg: ['Magnesium', 'mg', '#3fb950'],
    zinc_mg: ['Zink', 'mg', '#e6db74'],
    selenium_mcg: ['Selen', 'mcg', '#ff6b9d'],
    iron_mg: ['Eisen', 'mg', '#f85149'],
    calcium_mg: ['Calcium', 'mg', '#79c0ff'],
    folate_mcg: ['FolsÃ¤ure', 'mcg', '#7ee787'],
  };
  let html = '';
  let covered = 0, total = 0;
  for (const [key, [name, unit, color]] of Object.entries(labels)) {
    const val = t[key] || 0;
    const goal = goals[key] || 1;
    const pct = Math.min(Math.round(val / goal * 100), 150);
    const barPct = Math.min(pct, 100);
    total++;
    if (pct >= 80) covered++;
    const status = pct >= 100 ? 'âœ…' : pct >= 50 ? 'ğŸ”µ' : 'âš ï¸';
    // Build per-meal breakdown for this micronutrient
    let srcHTML = '';
    if (window._allMeals) {
      const sources = window._allMeals.filter(m => (m[key] || 0) > 0).sort((a,b) => (b[key]||0) - (a[key]||0));
      if (sources.length) {
        srcHTML = `<div class="micro-sources" id="msrc-${key}" style="display:none;margin-top:4px;padding:6px 8px;background:#0d1117;border-radius:6px;font-size:0.8rem">`;
        for (const s of sources) {
          const sv = Math.round((s[key]||0)*10)/10;
          const spct = Math.round(sv/val*100);
          const mtype = s.meal_type === 'supplement' ? 'ğŸ’Š' : s.meal_type === 'breakfast' ? 'ğŸŒ…' : s.meal_type === 'lunch' ? 'â˜€ï¸' : s.meal_type === 'dinner' ? 'ğŸŒ™' : 'ğŸ';
          srcHTML += `<div class="d-flex justify-content-between mb-1"><span>${mtype} ${s.description}</span><span style="color:${color}"><strong>${sv}${unit}</strong> <small class="text-muted">(${spct}%)</small></span></div>`;
        }
        srcHTML += `</div>`;
      }
    }
    const clickAttr = srcHTML ? `onclick="let e=document.getElementById('msrc-${key}');e.style.display=e.style.display==='none'?'block':'none'" style="cursor:pointer;font-size:0.85rem"` : `style="font-size:0.85rem"`;
    html += `<div class="mb-2">
      <div class="d-flex justify-content-between" ${clickAttr}>
        <span>${status} ${name} ${srcHTML ? '<small class="text-muted">â–¸</small>' : ''}</span>
        <span><strong style="color:${color}">${Math.round(val*10)/10}${unit}</strong> / ${goal}${unit} <small class="text-muted">(${pct}%)</small></span>
      </div>
      <div class="progress" style="height:8px;background:#21262d">
        <div class="progress-bar" style="width:${barPct}%;background:${color}"></div>
      </div>
      ${srcHTML}
    </div>`;
  }
  document.getElementById('microBars').innerHTML = html;
  document.getElementById('microSummary').textContent = `${covered}/${total} Ziele â‰¥80%`;
}

// === Sugar Split rendering in NÃ¤hrwert-Analyse ===
function renderSugarSplit(summary) {
  const t = summary.totals || {};
  const total = t.sugar_g || 0;
  const nat = t.sugar_natural_g || 0;
  const added = t.sugar_added_g || 0;
  const uncat = Math.max(0, total - nat - added);
  if (total <= 0) return '';
  const natPct = Math.round(nat / total * 100);
  const addPct = Math.round(added / total * 100);
  const uncPct = 100 - natPct - addPct;
  return `<div class="mt-1 mb-2">
    <div class="d-flex justify-content-between" style="font-size:0.82rem">
      <span>ğŸ¬ Zucker-Split: <strong>${Math.round(total)}g</strong></span>
      <span>
        ${nat > 0 ? `<span style="color:#3fb950">ğŸ ${Math.round(nat)}g natÃ¼rlich</span> ` : ''}
        ${added > 0 ? `<span style="color:#f85149">ğŸ§ ${Math.round(added)}g zugesetzt</span> ` : ''}
        ${uncat > 0 ? `<span class="text-muted">${Math.round(uncat)}g unkategorisiert</span>` : ''}
      </span>
    </div>
    <div class="d-flex rounded overflow-hidden" style="height:10px;background:#21262d">
      ${nat > 0 ? `<div style="width:${natPct}%;background:#3fb950" title="NatÃ¼rlich ${Math.round(nat)}g"></div>` : ''}
      ${added > 0 ? `<div style="width:${addPct}%;background:#f85149" title="Zugesetzt ${Math.round(added)}g"></div>` : ''}
      ${uncat > 0 ? `<div style="width:${uncPct}%;background:#6c757d" title="Unkategorisiert ${Math.round(uncat)}g"></div>` : ''}
    </div>
  </div>`;
}

loadAll();
loadSupplements();
loadProstataAnalysis();
loadCardioAnalysis();
loadCaffeine();
</script>
</body>
</html>
