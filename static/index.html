<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ¥— Nutrition Tracker</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{background:#0d1117;color:#c9d1d9}
.card{background:#161b22;border:1px solid #30363d}
.progress{background:#21262d;height:28px;border-radius:8px}
.meal-card{border-left:4px solid #58a6ff;margin-bottom:8px;padding:10px 14px;background:#161b22;border-radius:6px}
.meal-card.breakfast{border-color:#f0883e}.meal-card.lunch{border-color:#3fb950}.meal-card.dinner{border-color:#bc8cff}.meal-card.snack{border-color:#58a6ff}
.btn-del{opacity:0.5}.btn-del:hover{opacity:1}
canvas{max-height:220px}
.macro-label{font-size:0.85rem;opacity:0.7}
</style>
</head>
<body>
<div class="container py-4" style="max-width:900px">
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">ğŸ¥— Nutrition Tracker</h3>
  <div><input type="date" id="dateInput" class="form-control form-control-sm" style="width:160px;display:inline-block">
  <button class="btn btn-sm btn-primary ms-2" onclick="showAddModal()">+ Mahlzeit</button></div>
</div>

<!-- Summary -->
<div class="card p-3 mb-3">
  <div class="d-flex justify-content-between mb-1"><strong>Kalorien</strong><span id="calText">0 / 2000 kcal</span></div>
  <div class="progress"><div id="calBar" class="progress-bar bg-success" style="width:0%"></div></div>
  <div id="workoutBar" class="mt-2" style="display:none"></div>
  <div class="row mt-3 text-center">
    <div class="col-4"><canvas id="donutChart" height="180"></canvas></div>
    <div class="col-8 d-flex align-items-center">
      <div class="row w-100" id="macroStats"></div>
    </div>
  </div>
</div>

<!-- Meals -->
<div id="mealsList" class="mb-4"></div>

<!-- Supplements -->
<div class="card p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center" style="cursor:pointer" onclick="toggleAcc('suppBody')">
    <h6 class="mb-0">ğŸ’Š Supplements <span id="suppBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></h6>
    <span id="suppProgress" class="text-muted" style="font-size:0.85rem">0 / 12 Dosen heute eingenommen</span>
  </div>
  <div id="suppBody" style="display:none">
    <div class="progress mt-2 mb-3" style="height:12px">
      <div id="suppBar" class="progress-bar bg-info" style="width:0%"></div>
    </div>
    <div id="suppList"></div>
  </div>
</div>

<!-- Prostata-Analyse -->
<div class="card p-3 mb-3">
  <h6 style="cursor:pointer" onclick="toggleAcc('prostataBody')" class="d-flex align-items-center gap-2 flex-wrap">
    <span>ğŸ”¬ Prostata-Analyse <span id="prostataBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></span>
    <span id="prostataAlerts" class="d-flex gap-1 flex-wrap"></span>
  </h6>
  <div id="prostataBody" style="display:none">
    <div class="table-responsive">
      <table class="table table-sm table-dark mb-2" style="font-size:0.85rem">
        <thead><tr><th>Substanz</th><th>Quelle</th><th>TÃ¤gl. Menge</th><th>Opt. Bereich</th><th>Status</th></tr></thead>
        <tbody id="prostataTableBody">
          <tr><td colspan="5" class="text-muted text-center">Laden...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="alert alert-info py-2 mb-2" style="font-size:0.85rem">
      ğŸ’¡ <strong>Lycopin-Tipp:</strong> 1â€“2 EL Tomatenmark tÃ¤glich in SoÃŸen liefert 10â€“30mg Lycopin mit hÃ¶chster BioverfÃ¼gbarkeit â€” wÃ¼rde den einzigen Mangel im Stack beheben.
    </div>
    <div class="alert alert-warning py-2 mb-2" style="font-size:0.85rem">
      âš ï¸ <strong>GrÃ¼ner Tee-PS:</strong> NIEMALS nÃ¼chtern (HepatotoxizitÃ¤t!) â€” immer zu einer Mahlzeit. Ab 19.02.2026: 2 Kaps. morgens + 1 Kaps. abends.
    </div>
    <div class="alert alert-secondary py-2 mb-0" style="font-size:0.85rem">
      âœ… <strong>Vitamin D3:</strong> Dekristolvit D3 4.000 IU (morgens zum FrÃ¼hstÃ¼ck) + 800 IU aus curcumin-Loges = <strong>4.800 IU/Tag</strong>. Knapp Ã¼ber konservativem EU-Limit, bei aktiver Surveillance vertretbar und von Onkologen empfohlen.
    </div>
  </div>
</div>

<!-- Herz-Kreislauf Analyse -->
<div class="card p-3 mb-3">
  <h6 style="cursor:pointer" onclick="toggleAcc('cardioBody')" class="d-flex align-items-center gap-2 flex-wrap">
    <span>â¤ï¸ Herz-Kreislauf Analyse <span id="cardioBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></span>
    <span id="cardioAlerts" class="d-flex gap-1 flex-wrap"></span>
  </h6>
  <div id="cardioBody" style="display:none">
    <div class="table-responsive">
      <table class="table table-sm table-dark mb-2" style="font-size:0.85rem">
        <thead><tr><th>Substanz</th><th>Quelle</th><th>TÃ¤gl. Menge</th><th>Opt. Bereich</th><th>Status</th><th>Hinweis</th></tr></thead>
        <tbody id="cardioTableBody">
          <tr><td colspan="6" class="text-muted text-center">Laden...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="alert alert-info py-2 mb-2" style="font-size:0.85rem">
      ğŸ’Š <strong>MiraCHOL-Synergie:</strong> Monacolin K (Cholesterin-Hemmer) + Ubiquinol (CoQ10-Schutz) â€” clevere Kombination: Monacolin K erschÃ¶pft kÃ¶rpereigenes CoQ10, Ubiquinol kompensiert das direkt.
    </div>
    <div class="alert alert-info py-2 mb-2" style="font-size:0.85rem">
      ğŸ£ <strong>Lachs-Tipp:</strong> 2â€“3Ã— pro Woche 150g Lachs senkt Triglyzeride deutlich (EPA/DHA Omega-3).
    </div>
    <div class="alert alert-warning py-2 mb-0" style="font-size:0.85rem">
      ğŸ¬ <strong>Zucker-Hinweis:</strong> ErhÃ¶hter Zuckerkonsum â†’ Triglyzeride â†‘ â†’ LDL â†‘ â€” Monacolin K und Omega-3 wirken dem entgegen.
    </div>
  </div>
</div>

<!-- NÃ¤hrwert-Analyse -->
<div class="card p-3 mb-3">
  <h6 style="cursor:pointer" onclick="toggleAcc('nutriBody')">ğŸ”¬ NÃ¤hrwert-Analyse <span id="nutriBody-icon" style="transition:transform 0.2s;display:inline-block;font-size:0.8rem">â–¼</span></h6>
  <div id="macroDistDisplay"></div>
  <div id="nutriBody" style="display:none">
    <div id="nutriAnalysis"></div>
  </div>
</div>

<!-- Week Trend -->
<div class="card p-3 mb-3"><h6>ğŸ“Š Wochentrend</h6><canvas id="weekChart" height="140"></canvas></div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="mealModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content" style="background:#161b22">
<div class="modal-header border-secondary"><h5 class="modal-title" id="modalTitle">Mahlzeit hinzufÃ¼gen</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<form id="mealForm">
<input type="hidden" id="mealId">
<div class="row g-2 mb-2">
  <div class="col-6"><select id="mType" class="form-select form-select-sm"><option value="breakfast">FrÃ¼hstÃ¼ck</option><option value="lunch">Mittagessen</option><option value="dinner">Abendessen</option><option value="snack">Snack</option></select></div>
  <div class="col-6"><input type="date" id="mDate" class="form-control form-control-sm"></div>
</div>
<input id="mDesc" class="form-control form-control-sm mb-2" placeholder="Beschreibung" required>
<div class="row g-2 mb-2">
  <div class="col-4"><input id="mCal" type="number" step="any" class="form-control form-control-sm" placeholder="kcal"></div>
  <div class="col-4"><input id="mProt" type="number" step="any" class="form-control form-control-sm" placeholder="Protein (g)"></div>
  <div class="col-4"><input id="mFat" type="number" step="any" class="form-control form-control-sm" placeholder="Fett (g)"></div>
</div>
<div class="row g-2 mb-2">
  <div class="col-4"><input id="mCarbs" type="number" step="any" class="form-control form-control-sm" placeholder="KH (g)"></div>
  <div class="col-4"><input id="mFiber" type="number" step="any" class="form-control form-control-sm" placeholder="Ballast. (g)"></div>
  <div class="col-4"><input id="mSugar" type="number" step="any" class="form-control form-control-sm" placeholder="Zucker (g)"></div>
</div>
<input id="mNotes" class="form-control form-control-sm mb-2" placeholder="Notizen">
<div id="componentsSection">
  <hr class="border-secondary my-2">
  <small class="text-muted">Zutaten / Komponenten</small>
  <div id="compList"></div>
  <a href="#" class="text-decoration-none" style="font-size:0.85rem" onclick="addCompRow();return false">+ Zutat hinzufÃ¼gen</a>
</div>
</form>
</div>
<div class="modal-footer border-secondary"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Abbrechen</button><button class="btn btn-primary btn-sm" onclick="saveMeal()">Speichern</button></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = '';
let currentDate = new Date().toISOString().slice(0,10);
const dateInput = document.getElementById('dateInput');
dateInput.value = currentDate;
dateInput.onchange = () => { currentDate = dateInput.value; loadAll(); loadSupplements(); loadProstataAnalysis(); loadCardioAnalysis(); };

const mealLabels = {breakfast:'ğŸŒ… FrÃ¼hstÃ¼ck',lunch:'ğŸ½ï¸ Mittagessen',dinner:'ğŸŒ™ Abendessen',snack:'ğŸ Snacks'};
const mealColors = {breakfast:'#f0883e',lunch:'#3fb950',dinner:'#bc8cff',snack:'#58a6ff'};

async function loadAll() {
  const [meals, summary, week] = await Promise.all([
    fetch(`${API}/api/meals?date=${currentDate}`).then(r=>r.json()),
    fetch(`${API}/api/summary/${currentDate}`).then(r=>r.json()),
    fetch(`${API}/api/summary/week/${currentDate}`).then(r=>r.json())
  ]);
  renderSummary(summary);
  renderMeals(meals);
  renderNutriAnalysis(summary);
  renderWeek(week);
}

function renderSummary(s) {
  const t = s.totals, pct = Math.min(s.progress.calories, 100);
  const w = s.workout || {};
  const calGoal = s.goals.calories || 2000;
  const netCal = s.net_calories ?? Math.round(t.calories);

  // Kalorien-Header
  let calLabel = `${Math.round(t.calories)} / ${calGoal} kcal`;
  if (w.kcal_burned > 0) calLabel += ` (Netto: ${netCal} kcal)`;
  document.getElementById('calText').textContent = calLabel;

  const bar = document.getElementById('calBar');
  bar.style.width = pct+'%';
  bar.className = 'progress-bar ' + (pct > 100 ? 'bg-danger' : pct > 80 ? 'bg-warning' : 'bg-success');

  // Workout-Info
  const wDiv = document.getElementById('workoutBar');
  if (w.has_workout && w.kcal_burned > 0) {
    const zoneColors = {1:'#58a6ff',2:'#3fb950',3:'#ffc107',4:'#f0883e',5:'#f85149'};
    const zc = zoneColors[w.zone] || '#58a6ff';
    wDiv.style.display = '';
    wDiv.innerHTML = `<div class="p-2 rounded d-flex flex-wrap gap-3 align-items-center" style="background:#0d1117;font-size:0.85rem">
      <span>ğŸ‹ï¸ <strong>${w.duration_min} min</strong></span>
      ${w.avg_hr ? `<span>â¤ï¸ Ã˜ ${w.avg_hr} bpm <small class="text-muted">(HRmax ${w.hr_max})</small></span>` : ''}
      <span style="color:${zc}">âš¡ Zone ${w.zone}: ${w.zone_label}</span>
      <span>ğŸ”¥ âˆ’${w.kcal_burned} kcal verbrannt</span>
      <span style="color:#f0883e">ğŸ«™ ~${w.fat_g_burned}g Fett</span>
      <span style="color:#3fb950">ğŸŒ¾ ~${w.kh_g_burned}g KH</span>
      <span class="ms-auto text-muted">Kalorienkorrektur: +${w.kcal_burned} kcal Ziel</span>
    </div>`;
  } else {
    wDiv.style.display = 'none';
  }

  document.getElementById('macroStats').innerHTML = [
    ['Protein', t.protein_g, s.goals.protein_g, '#58a6ff'],
    ['Fett', t.fat_g, s.goals.fat_g, '#f0883e'],
    ['Kohlenhydrate', t.carbs_g, s.goals.carbs_g, '#3fb950'],
    ['Ballaststoffe', t.fiber_g, s.goals.fiber_g, '#bc8cff']
  ].map(([n,v,g,c])=>`<div class="col-6 mb-2"><div class="macro-label">${n}</div><strong style="color:${c}">${Math.round(v*10)/10}g</strong> <small class="text-muted">/ ${g}g</small></div>`).join('');

  const ww = s.workout || {};
  drawDonut(t.protein_g, Math.max(0, t.fat_g-(ww.fat_g_burned||0)), Math.max(0, t.carbs_g-(ww.kh_g_burned||0)));
}

function drawDonut(p, f, c) {
  const canvas = document.getElementById('donutChart'), ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2, H = canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2,2); const w=W/2, h=H/2, cx=w/2, cy=h/2, r=Math.min(w,h)/2-10, inner=r*0.6;
  ctx.clearRect(0,0,w,h);
  const total = p+f+c || 1;
  const slices = [[p,'#58a6ff','P'],[f,'#f0883e','F'],[c,'#3fb950','KH']];
  let angle = -Math.PI/2;
  slices.forEach(([v, color, label]) => {
    const sweep = (v/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,angle,angle+sweep); ctx.fillStyle=color; ctx.fill();
    angle += sweep;
  });
  ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fillStyle='#161b22'; ctx.fill();
  ctx.fillStyle='#c9d1d9'; ctx.font='bold 11px sans-serif'; ctx.textAlign='center';
  ctx.fillText(`${Math.round(p+f+c)}g`, cx, cy+4);
}

function renderMeals(meals) {
  const grouped = {};
  meals.forEach(m => { (grouped[m.meal_type] = grouped[m.meal_type]||[]).push(m); });
  let html = '';
  for (const type of ['breakfast','lunch','dinner','snack']) {
    const items = grouped[type];
    if (!items) continue;

    // Summen berechnen
    const sumCal  = items.reduce((a,m)=>a+m.calories,0);
    const sumProt = items.reduce((a,m)=>a+m.protein_g,0);
    const sumFat  = items.reduce((a,m)=>a+m.fat_g,0);
    const sumCarb = items.reduce((a,m)=>a+m.carbs_g,0);
    const accId = `acc-${type}`;

    // Accordion Header (Zusammenfassung)
    html += `
    <div class="meal-card ${type} mb-2 p-0" style="overflow:hidden">
      <div class="d-flex justify-content-between align-items-center px-3 py-2" 
           style="cursor:pointer" onclick="toggleAcc('${accId}')">
        <div>
          <strong>${mealLabels[type]}</strong>
          <span class="ms-2 text-muted" style="font-size:0.85rem">${items.length} Eintr.</span>
        </div>
        <div class="d-flex align-items-center gap-3">
          <span style="font-size:0.85rem">
            <strong>${Math.round(sumCal)} kcal</strong>
            <span class="text-muted ms-2">${Math.round(sumProt*10)/10}P Â· ${Math.round(sumFat*10)/10}F Â· ${Math.round(sumCarb*10)/10}KH</span>
          </span>
          <span id="${accId}-icon" style="transition:transform 0.2s">â–¼</span>
        </div>
      </div>
      <!-- Einzelpositionen (kollabierbar) -->
      <div id="${accId}" style="display:none;border-top:1px solid rgba(255,255,255,0.08)">`;

    items.forEach(m => {
      const hasComps = m.components && m.components.length > 0;
      const compId = `comp-${m.id}`;
      html += `
        <div class="d-flex justify-content-between align-items-start px-3 py-2" style="border-bottom:1px solid rgba(255,255,255,0.04)">
          <div style="flex:1">
            <span>${hasComps ? `<span style="cursor:pointer;font-size:0.8rem;margin-right:4px" onclick="toggleAcc('${compId}')" id="${compId}-icon">â–¶</span>` : ''}${m.description}</span>
            <br><small class="text-muted">${Math.round(m.calories)} kcal Â· ${m.protein_g}P Â· ${m.fat_g}F Â· ${m.carbs_g}KH${m.fiber_g>0?' Â· '+m.fiber_g+'Bal':''}</small>
            ${m.notes ? '<br><small class="text-muted fst-italic">'+m.notes+'</small>' : ''}
            ${hasComps ? `<div id="${compId}" style="display:none;margin-top:6px;padding-left:18px;border-left:2px solid rgba(255,255,255,0.1)">
              ${m.components.map(c => `<div style="font-size:0.82rem;padding:2px 0"><span style="color:#8b949e">â†³</span> ${c.description} <small class="text-muted">${Math.round(c.calories)} kcal Â· ${c.protein_g}P Â· ${c.fat_g}F Â· ${c.carbs_g}KH</small></div>`).join('')}
            </div>` : ''}
          </div>
          <div class="text-nowrap ms-2">
            <button class="btn btn-sm btn-outline-secondary me-1 py-0" onclick="editMeal(${m.id})">âœï¸</button>
            <button class="btn btn-sm btn-outline-danger btn-del py-0" onclick="deleteMeal(${m.id})">ğŸ—‘ï¸</button>
          </div>
        </div>`;
    });

    html += `
        <div class="px-3 py-2">
          <button class="btn btn-sm btn-outline-secondary py-0" onclick="addForType('${type}')">+ Eintrag hinzufÃ¼gen</button>
        </div>
      </div>
    </div>`;
  }
  document.getElementById('mealsList').innerHTML = html || '<p class="text-muted">Keine Mahlzeiten fÃ¼r diesen Tag.</p>';
}

function toggleAcc(id) {
  const el = document.getElementById(id);
  const icon = document.getElementById(id+'-icon');
  const open = el.style.display !== 'none';
  el.style.display = open ? 'none' : 'block';
  icon.style.transform = open ? '' : 'rotate(180deg)';
}

function addForType(type) {
  document.getElementById('mealId').value = '';
  document.getElementById('mealForm').reset();
  document.getElementById('mDate').value = currentDate;
  document.getElementById('mType').value = type;
  document.getElementById('compList').innerHTML = '';
  document.getElementById('modalTitle').textContent = 'Eintrag hinzufÃ¼gen';
  new bootstrap.Modal(document.getElementById('mealModal')).show();
}

function renderNutriAnalysis(s) {
  const t = s.totals, g = s.goals;
  const w = s.workout || {};
  const kcal = t.calories;

  // Netto-Werte nach Workout
  const netFat = Math.max(0, t.fat_g - (w.fat_g_burned || 0));
  const netKH  = Math.max(0, t.carbs_g - (w.kh_g_burned || 0));

  // Empfohlene Makro-Verteilung (% der Kalorien, auf Netto-Basis)
  const protKcal = t.protein_g * 4;
  const fatKcal  = netFat * 9;
  const carbKcal = netKH * 4;
  const totalMacroKcal = protKcal + fatKcal + carbKcal || 1;

  const protPct = Math.round(protKcal / totalMacroKcal * 100);
  const fatPct  = Math.round(fatKcal  / totalMacroKcal * 100);
  const carbPct = Math.round(carbKcal / totalMacroKcal * 100);

  const netCal = s.net_calories ?? Math.round(kcal);
  const calMin = Math.round((g.calories || 2000) * 0.8);
  const calMax = Math.round((g.calories || 2000) * 1.1);

  // Workout-Hinweis fÃ¼r Analyse
  const workoutNote = w.has_workout && w.kcal_burned > 0
    ? ` <small class="text-muted">Â· Netto nach Training: ${netCal} kcal</small>` : '';
  const fatNote = w.has_workout && w.fat_g_burned > 0
    ? `${fatPct}% Netto-Energie Â· ${w.fat_g_burned}g durch Training verbrannt` : `${fatPct}% der Energie`;
  const khNote = w.has_workout && w.kh_g_burned > 0
    ? `${carbPct}% Netto-Energie Â· ${w.kh_g_burned}g durch Training verbrannt` : `${carbPct}% der Energie`;

  // Zielkorridore
  const targets = [
    { name: 'Kalorien', unit: 'kcal', val: netCal, min: calMin, max: calMax, goal: g.calories || 2000, icon: 'ğŸ”¥', note: workoutNote ? `Brutto: ${Math.round(kcal)} kcal${workoutNote}` : '' },
    { name: 'Protein', unit: 'g', val: t.protein_g, min: 60, max: 120, goal: g.protein_g, icon: 'ğŸ’ª', note: `${protPct}% der Energie` },
    { name: 'Fett', unit: 'g', val: netFat, min: 45, max: 80, goal: g.fat_g, icon: 'ğŸ«™', note: fatNote },
    { name: 'Kohlenhydrate', unit: 'g', val: netKH, min: 180, max: 310, goal: g.carbs_g, icon: 'ğŸŒ¾', note: khNote },
    { name: 'Ballaststoffe', unit: 'g', val: t.fiber_g, min: 25, max: 40, goal: g.fiber_g, icon: 'ğŸ¥¦' },
    { name: 'Zucker', unit: 'g', val: t.sugar_g, min: 0, max: 50, goal: 50, icon: 'ğŸ¬', note: 'Max. 50g/Tag empfohlen', invert: true },
  ];

  // Empfohlene Makro-Verteilung Anzeige
  const macroDistHTML = `
    <div class="mb-3 p-2 rounded" style="background:#0d1117">
      <div class="d-flex justify-content-between mb-1"><small class="text-muted">Makro-Verteilung (% der Energie)</small><small class="text-muted">Empfehlung: P 15-25% Â· F 25-35% Â· KH 45-60%</small></div>
      <div class="d-flex rounded overflow-hidden" style="height:22px">
        <div style="width:${protPct}%;background:#58a6ff" title="Protein ${protPct}%"></div>
        <div style="width:${fatPct}%;background:#f0883e" title="Fett ${fatPct}%"></div>
        <div style="width:${carbPct}%;background:#3fb950" title="KH ${carbPct}%"></div>
      </div>
      <div class="d-flex gap-3 mt-1">
        <small><span style="color:#58a6ff">â– </span> Protein ${protPct}% ${protPct>=15&&protPct<=25?'âœ…':'âš ï¸'}</small>
        <small><span style="color:#f0883e">â– </span> Fett ${fatPct}% ${fatPct>=25&&fatPct<=35?'âœ…':'âš ï¸'}</small>
        <small><span style="color:#3fb950">â– </span> KH ${carbPct}% ${carbPct>=45&&carbPct<=60?'âœ…':'âš ï¸'}</small>
      </div>
    </div>`;

  const rows = targets.map(({name, unit, val, min, max, goal, icon, note, invert}) => {
    const pct = Math.min(Math.round(val / goal * 100), 150);
    let status, color, badge;
    if (invert) {
      status = val <= max ? 'âœ…' : val <= max*1.2 ? 'âš ï¸' : 'ğŸ”´';
      color = val <= max ? '#3fb950' : val <= max*1.2 ? '#ffc107' : '#f85149';
      badge = val <= max ? 'OK' : 'Zu hoch';
    } else {
      const ok = val >= min && val <= max;
      const low = val < min;
      status = ok ? 'âœ…' : low ? 'ğŸ”µ' : 'âš ï¸';
      color = ok ? '#3fb950' : low ? '#58a6ff' : '#ffc107';
      badge = ok ? 'Optimal' : low ? 'Zu niedrig' : 'Zu hoch';
    }
    const barPct = Math.min(pct, 100);
    return `
      <div class="mb-2">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span>${icon} <strong>${name}</strong>${note ? ' <small class="text-muted">Â· '+note+'</small>' : ''}</span>
          <span>${status} <strong style="color:${color}">${Math.round(val*10)/10}${unit}</strong> <small class="text-muted">/ Ziel ${goal}${unit}</small> <span class="badge ms-1" style="background:${color};color:#000;font-size:0.7rem">${badge}</span></span>
        </div>
        <div class="progress" style="height:8px;background:#21262d">
          <div class="progress-bar" style="width:${barPct}%;background:${color}"></div>
        </div>
        <div class="d-flex justify-content-between mt-1"><small class="text-muted">Min ${min}${unit}</small><small class="text-muted">Max ${max}${unit}</small></div>
      </div>`;
  }).join('');

  // Zuckerwarnung
  const sugarWarn = t.sugar_g > 50 ? `<div class="alert alert-warning py-2 mt-2" style="font-size:0.85rem">âš ï¸ <strong>Zucker:</strong> ${Math.round(t.sugar_g)}g heute â€” deutlich Ã¼ber dem Tagesziel von 50g. GroÃŸteils aus Granatapfelsaft und FrÃ¼chten (natÃ¼rlicher Zucker).</div>` : '';

  document.getElementById('macroDistDisplay').innerHTML = macroDistHTML;
  document.getElementById('nutriAnalysis').innerHTML = rows + sugarWarn;
}

function renderWeek(w) {
  const canvas = document.getElementById('weekChart'), ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2, H = canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2,2); const cw=W/2, ch=H/2;
  ctx.clearRect(0,0,cw,ch);
  const max = Math.max(2000, ...w.days.map(d=>d.calories)) * 1.1;
  const barW = (cw-60)/7, pad = 8;
  w.days.forEach((d,i) => {
    const x = 40 + i*barW, h2 = (d.calories/max)*(ch-40);
    const color = d.calories > 2000 ? '#f85149' : '#3fb950';
    ctx.fillStyle = color; ctx.fillRect(x+pad, ch-25-h2, barW-pad*2, h2);
    ctx.fillStyle = '#8b949e'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(d.date.slice(5), x+barW/2, ch-8);
    if (d.calories > 0) { ctx.fillStyle='#c9d1d9'; ctx.fillText(Math.round(d.calories), x+barW/2, ch-30-h2); }
  });
  // goal line
  const goalY = ch - 25 - (2000/max)*(ch-40);
  ctx.strokeStyle = '#f0883e'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(40,goalY); ctx.lineTo(cw-20,goalY); ctx.stroke();
  ctx.setLineDash([]); ctx.fillStyle='#f0883e'; ctx.font='9px sans-serif'; ctx.textAlign='left'; ctx.fillText('2000', 2, goalY+3);
}

let editComponents = [];

function addCompRow(comp) {
  const list = document.getElementById('compList');
  const idx = list.children.length;
  const div = document.createElement('div');
  div.className = 'row g-1 mb-1 align-items-center';
  div.innerHTML = `
    <div class="col-4"><input class="form-control form-control-sm comp-desc" placeholder="Zutat" value="${comp?.description||''}"></div>
    <div class="col-2"><input type="number" step="any" class="form-control form-control-sm comp-cal" placeholder="kcal" value="${comp?.calories||''}"></div>
    <div class="col-1"><input type="number" step="any" class="form-control form-control-sm comp-prot" placeholder="P" value="${comp?.protein_g||''}"></div>
    <div class="col-1"><input type="number" step="any" class="form-control form-control-sm comp-fat" placeholder="F" value="${comp?.fat_g||''}"></div>
    <div class="col-1"><input type="number" step="any" class="form-control form-control-sm comp-carbs" placeholder="KH" value="${comp?.carbs_g||''}"></div>
    <div class="col-1"><button class="btn btn-sm btn-outline-danger py-0" onclick="this.closest('.row').remove()">Ã—</button></div>`;
  list.appendChild(div);
}

function getCompRows() {
  return [...document.querySelectorAll('#compList .row')].map(row => ({
    description: row.querySelector('.comp-desc').value,
    calories: parseFloat(row.querySelector('.comp-cal').value)||0,
    protein_g: parseFloat(row.querySelector('.comp-prot').value)||0,
    fat_g: parseFloat(row.querySelector('.comp-fat').value)||0,
    carbs_g: parseFloat(row.querySelector('.comp-carbs').value)||0,
  })).filter(c => c.description.trim());
}

let allMeals = [];
function showAddModal() {
  document.getElementById('mealId').value = '';
  document.getElementById('mDate').value = currentDate;
  document.getElementById('mealForm').reset();
  document.getElementById('mDate').value = currentDate;
  document.getElementById('compList').innerHTML = '';
  document.getElementById('modalTitle').textContent = 'Mahlzeit hinzufÃ¼gen';
  new bootstrap.Modal(document.getElementById('mealModal')).show();
}

async function editMeal(id) {
  const meal = await fetch(`${API}/api/meals?date=${currentDate}`).then(r=>r.json()).then(ms=>ms.find(m=>m.id===id));
  if (!meal) return;
  document.getElementById('mealId').value = id;
  document.getElementById('mType').value = meal.meal_type;
  document.getElementById('mDate').value = meal.date;
  document.getElementById('mDesc').value = meal.description;
  document.getElementById('mCal').value = meal.calories;
  document.getElementById('mProt').value = meal.protein_g;
  document.getElementById('mFat').value = meal.fat_g;
  document.getElementById('mCarbs').value = meal.carbs_g;
  document.getElementById('mFiber').value = meal.fiber_g;
  document.getElementById('mSugar').value = meal.sugar_g;
  document.getElementById('mNotes').value = meal.notes;
  // Load components
  document.getElementById('compList').innerHTML = '';
  if (meal.components && meal.components.length > 0) {
    meal.components.forEach(c => addCompRow(c));
  }
  document.getElementById('modalTitle').textContent = 'Mahlzeit bearbeiten';
  new bootstrap.Modal(document.getElementById('mealModal')).show();
}

async function saveMeal() {
  const id = document.getElementById('mealId').value;
  const data = {
    date: document.getElementById('mDate').value,
    meal_type: document.getElementById('mType').value,
    description: document.getElementById('mDesc').value,
    calories: parseFloat(document.getElementById('mCal').value)||0,
    protein_g: parseFloat(document.getElementById('mProt').value)||0,
    fat_g: parseFloat(document.getElementById('mFat').value)||0,
    carbs_g: parseFloat(document.getElementById('mCarbs').value)||0,
    fiber_g: parseFloat(document.getElementById('mFiber').value)||0,
    sugar_g: parseFloat(document.getElementById('mSugar').value)||0,
    notes: document.getElementById('mNotes').value,
    source: 'manual'
  };
  const url = id ? `${API}/api/meals/${id}` : `${API}/api/meals`;
  const resp = await fetch(url, {method: id?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
  const saved = await resp.json();
  const mealId = id || saved.id;
  // Save components: delete existing, re-add
  const comps = getCompRows();
  if (mealId) {
    // Delete old components
    const oldComps = await fetch(`${API}/api/meals/${mealId}/components`).then(r=>r.json());
    for (const c of oldComps) await fetch(`${API}/api/meals/${mealId}/components/${c.id}`, {method:'DELETE'});
    // Add new
    for (let i=0; i<comps.length; i++) {
      await fetch(`${API}/api/meals/${mealId}/components`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({...comps[i], sort_order:i})});
    }
  }
  bootstrap.Modal.getInstance(document.getElementById('mealModal')).hide();
  loadAll();
  loadProstataAnalysis();
  loadCardioAnalysis();
}

async function deleteMeal(id) {
  if (!confirm('Mahlzeit lÃ¶schen?')) return;
  await fetch(`${API}/api/meals/${id}`, {method:'DELETE'});
  loadAll();
  loadProstataAnalysis();
  loadCardioAnalysis();
}

// === Supplements ===
async function loadSupplements() {
  const data = await fetch(`${API}/api/supplement-intake/${currentDate}`).then(r => r.json());
  // Count total doses and taken doses
  let totalDoses = 0, takenDoses = 0;
  data.forEach(s => {
    s.doses.forEach(d => { totalDoses++; if (d.taken) takenDoses++; });
  });
  document.getElementById('suppProgress').textContent = `${takenDoses} / ${totalDoses} Dosen heute eingenommen`;
  const pct = totalDoses > 0 ? Math.round(takenDoses / totalDoses * 100) : 0;
  const bar = document.getElementById('suppBar');
  bar.style.width = pct + '%';
  bar.className = 'progress-bar ' + (pct === 100 ? 'bg-success' : 'bg-info');

  const categoryIcons = {prostata:'ğŸ¯',leber:'ğŸ«',entzÃ¼ndung:'ğŸ”¥',herz:'â¤ï¸',antioxidans:'ğŸµ',general:'ğŸ’Š'};
  const slotTimes = {morning:'07:00', noon:'12:00', evening:'19:00'};
  let html = '<div class="list-group list-group-flush">';
  data.forEach(s => {
    const prostBadge = s.prostate_relevant ? ' <span class="badge bg-info" style="font-size:0.7rem">ğŸ¯ Prostata</span>' : '';
    // Build dose checkboxes
    let dosesHtml = '';
    s.doses.forEach(d => {
      const time = slotTimes[d.dose_slot] || d.taken_at || '';
      // Show capsule count per slot if > 1
      const doseCountKey = 'dose_' + d.dose_slot;
      const doseCount = s[doseCountKey] || 1;
      const countLabel = doseCount > 1 ? ` (${doseCount} Kaps.)` : '';
      dosesHtml += `
        <div class="form-check form-check-inline me-3">
          <input class="form-check-input" type="checkbox" id="supp-${s.supplement_id}-${d.dose_slot}"
            ${d.taken ? 'checked' : ''} onchange="toggleSupplement(${s.supplement_id}, '${d.dose_slot}', this.checked)">
          <label class="form-check-label" for="supp-${s.supplement_id}-${d.dose_slot}" style="font-size:0.85rem;cursor:pointer">${time}${countLabel}</label>
        </div>`;
    });

    html += `
      <div class="list-group-item d-flex align-items-center px-2 py-2" style="background:transparent;border-color:rgba(255,255,255,0.08)">
        <div class="d-flex align-items-center me-2" style="min-width:80px">
          ${dosesHtml}
        </div>
        <div style="flex:1">
          <strong>${s.name}</strong>${prostBadge}
          <br><small class="text-muted">${s.dose_per_day} ${s.unit} Â· ${s.key_ingredients}</small>
        </div>
      </div>`;
  });
  html += '</div>';
  document.getElementById('suppList').innerHTML = html;
}

async function toggleSupplement(suppId, doseSlot, taken) {
  await fetch(`${API}/api/supplement-intake`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({date: currentDate, supplement_id: suppId, dose_slot: doseSlot, taken: taken ? 1 : 0})
  });
  loadSupplements();
  loadProstataAnalysis();
  loadCardioAnalysis();
}

// === Prostata-Analyse ===
async function loadProstataAnalysis() {
  try {
    const data = await fetch(`${API}/api/prostate-analysis/${currentDate}`).then(r => r.json());
    renderProstataAnalysis(data);
  } catch (e) {
    console.error('Prostata analysis error:', e);
  }
}

function renderProstataAnalysis(data) {
  const tbody = document.getElementById('prostataTableBody');
  if (!data || !data.substances || data.substances.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">Keine Daten</td></tr>';
    return;
  }

  let html = '';
  data.substances.forEach(s => {
    // Status badge
    let badge;
    if (s.status === 'optimal') {
      badge = '<span class="badge bg-success">âœ… Optimal</span>';
    } else if (s.status === 'low') {
      badge = '<span class="badge bg-warning text-dark">âš ï¸ Zu niedrig</span>';
    } else if (s.status === 'high') {
      badge = '<span class="badge bg-danger">ğŸ”´ Zu hoch</span>';
    } else {
      badge = '<span class="badge bg-secondary">â€”</span>';
    }

    // Amount display
    const amount = s.total > 0 ? `${s.total} ${s.unit}` : 'â€”';

    // Sources
    const sources = s.sources.length > 0 ? s.sources.join('<br>') : '<span class="text-muted">â€”</span>';

    // Breakdown (supplements + food)
    let breakdown = '';
    if (s.total > 0) {
      const parts = [];
      if (s.from_supplements > 0) parts.push(`ğŸ’Š ${s.from_supplements}${s.unit}`);
      if (s.from_food > 0) parts.push(`ğŸ¥— ${s.from_food}${s.unit}`);
      breakdown = parts.length > 0 ? `<br><small class="text-muted">${parts.join(' + ')}</small>` : '';
    }

    html += `<tr>
      <td><strong>${s.name}</strong></td>
      <td style="font-size:0.8rem">${sources}</td>
      <td>${amount}${breakdown}</td>
      <td>${s.optimal_min}â€“${s.optimal_max} ${s.unit}</td>
      <td>${badge}</td>
    </tr>`;
  });

  tbody.innerHTML = html;

  // Update collapsed header badges
  const alerts = data.substances.filter(s => s.status !== 'optimal' && s.status !== 'none' && s.total > 0);
  const noData = data.substances.filter(s => s.status === 'none' || s.total === 0);
  let alertHtml = alerts.map(s => {
    const icon = s.status === 'high' ? 'ğŸ”´' : 'âš ï¸';
    const bg = s.status === 'high' ? 'bg-danger' : 'bg-warning text-dark';
    return `<span class="badge ${bg}" style="font-size:0.7rem">${icon} ${s.name}</span>`;
  }).join('');
  // Add count of missing if any
  if (noData.length > 0) {
    alertHtml += `<span class="badge bg-secondary" style="font-size:0.7rem">${noData.length} nicht eingenommen</span>`;
  }
  // If all taken and optimal
  if (alerts.length === 0 && noData.length === 0) {
    alertHtml = '<span class="badge bg-success" style="font-size:0.7rem">âœ… Alles optimal</span>';
  }
  document.getElementById('prostataAlerts').innerHTML = alertHtml;
}

// === Herz-Kreislauf Analyse ===
async function loadCardioAnalysis() {
  try {
    const data = await fetch(`${API}/api/cardio-analysis/${currentDate}`).then(r => r.json());
    renderCardioAnalysis(data);
  } catch (e) {
    console.error('Cardio analysis error:', e);
  }
}

function renderCardioAnalysis(data) {
  const tbody = document.getElementById('cardioTableBody');
  if (!data || !data.substances || data.substances.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">Keine Daten</td></tr>';
    return;
  }

  let html = '';
  data.substances.forEach(s => {
    let badge;
    if (s.status === 'optimal') {
      badge = '<span class="badge bg-success">âœ… Optimal</span>';
    } else if (s.status === 'low') {
      badge = '<span class="badge bg-warning text-dark">âš ï¸ Zu niedrig</span>';
    } else if (s.status === 'high') {
      badge = '<span class="badge bg-danger">ğŸ”´ Zu hoch</span>';
    } else {
      badge = '<span class="badge bg-secondary">â€”</span>';
    }

    const amount = s.total > 0 ? `${s.total} ${s.unit}` : 'â€”';
    const sources = s.sources.length > 0 ? s.sources.join('<br>') : '<span class="text-muted">â€”</span>';

    let breakdown = '';
    if (s.total > 0) {
      const parts = [];
      if (s.from_supplements > 0) parts.push(`ğŸ’Š ${s.from_supplements}${s.unit}`);
      if (s.from_food > 0) parts.push(`ğŸ¥— ${s.from_food}${s.unit}`);
      breakdown = parts.length > 0 ? `<br><small class="text-muted">${parts.join(' + ')}</small>` : '';
    }

    const note = s.note ? `<small class="text-muted">${s.note}</small>` : '';

    html += `<tr>
      <td><strong>${s.name}</strong></td>
      <td style="font-size:0.8rem">${sources}</td>
      <td>${amount}${breakdown}</td>
      <td>${s.optimal_min}â€“${s.optimal_max} ${s.unit}</td>
      <td>${badge}</td>
      <td style="font-size:0.8rem">${note}</td>
    </tr>`;
  });

  tbody.innerHTML = html;

  // Update collapsed header badges
  const alerts = data.substances.filter(s => s.status !== 'optimal' && s.status !== 'none' && s.total > 0);
  const noData = data.substances.filter(s => s.status === 'none' || s.total === 0);
  let alertHtml = alerts.map(s => {
    const icon = s.status === 'high' ? 'ğŸ”´' : 'âš ï¸';
    const bg = s.status === 'high' ? 'bg-danger' : 'bg-warning text-dark';
    return `<span class="badge ${bg}" style="font-size:0.7rem">${icon} ${s.name}</span>`;
  }).join('');
  if (noData.length > 0) {
    alertHtml += `<span class="badge bg-secondary" style="font-size:0.7rem">${noData.length} nicht eingenommen</span>`;
  }
  if (alerts.length === 0 && noData.length === 0) {
    alertHtml = '<span class="badge bg-success" style="font-size:0.7rem">âœ… Alles optimal</span>';
  }
  document.getElementById('cardioAlerts').innerHTML = alertHtml;
}

loadAll();
loadSupplements();
loadProstataAnalysis();
loadCardioAnalysis();
</script>
</body>
</html>
